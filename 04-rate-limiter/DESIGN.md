# Rate Limiter ç³»çµ±è¨­è¨ˆæ–‡æª”

## ğŸ“‹ å•é¡Œå®šç¾©

### æ¥­å‹™éœ€æ±‚
æ§‹å»ºé™æµç³»çµ±ï¼ˆRate Limiterï¼‰ï¼Œä¿è­·æœå‹™å…å—éè¼‰ï¼š
- **é˜²æ­¢éè¼‰**ï¼šé™åˆ¶æ¯å€‹ç”¨æˆ¶/IP çš„è«‹æ±‚é »ç‡
- **ä¿è­‰å…¬å¹³æ€§**ï¼šé˜²æ­¢å–®ä¸€ç”¨æˆ¶å ç”¨æ‰€æœ‰è³‡æº
- **æ”¯æŒçªç™¼æµé‡**ï¼šå…è¨±çŸ­æ™‚é–“å…§çš„æµé‡å³°å€¼
- **å¤šç¶­åº¦é™æµ**ï¼šæ”¯æŒæŒ‰ IPã€ç”¨æˆ¶ã€API ç«¯é»é™æµ
- **åˆ†å¸ƒå¼æ”¯æŒ**ï¼šå¤šæœå‹™å¯¦ä¾‹å…±äº«é™æµç‹€æ…‹

### æŠ€è¡“æŒ‡æ¨™
| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æŒ‘æˆ° |
|------|--------|------|
| **é™æµç²¾åº¦** | èª¤å·® < 5% | å¦‚ä½•ç²¾ç¢ºæ§åˆ¶æµé‡ï¼Ÿ |
| **å»¶é²é–‹éŠ·** | < 1ms (å–®æ©Ÿ) | å¦‚ä½•ä¿è­‰ä½å»¶é²ï¼Ÿ |
| **åˆ†å¸ƒå¼å»¶é²** | < 5ms (Redis) | å¦‚ä½•ä¿è­‰åŸå­æ€§ï¼Ÿ |
| **ååé‡** | 100K RPS (å–®æ©Ÿ) | å¦‚ä½•æ‰¿å—é«˜ä¸¦ç™¼ï¼Ÿ |
| **çªç™¼å®¹å¿** | 2x å¹³å‡æµé‡ | å¦‚ä½•è™•ç†çªç™¼ï¼Ÿ |

### ä½¿ç”¨å ´æ™¯
```
å ´æ™¯ 1ï¼šAPI é™æµ
- å…è²»ç”¨æˆ¶ï¼š100 req/hour
- ä»˜è²»ç”¨æˆ¶ï¼š1000 req/hour
- ä¼æ¥­ç”¨æˆ¶ï¼š10000 req/hour

å ´æ™¯ 2ï¼šé˜²æ­¢æš´åŠ›ç ´è§£
- ç™»éŒ„æ¥å£ï¼š5 æ¬¡/åˆ†é˜
- è¶…éå¾Œé–å®š 15 åˆ†é˜

å ´æ™¯ 3ï¼šä¿è­·è³‡æ–™åº«
- å¯«å…¥æ¥å£ï¼š1000 QPS
- è¶…éå¾Œè¿”å› 429 Too Many Requests
```

---

## ğŸ¤” è¨­è¨ˆæ±ºç­–æ¨¹

### æ±ºç­– 1ï¼šé¸æ“‡å“ªç¨®é™æµç®—æ³•ï¼Ÿ

```
éœ€æ±‚ï¼šé™åˆ¶ API æ¯ç§’æœ€å¤šè™•ç† 100 å€‹è«‹æ±‚

âŒ æ–¹æ¡ˆ Aï¼šè¨ˆæ•¸å™¨ï¼ˆFixed Window Counterï¼‰
   æ©Ÿåˆ¶ï¼šæ¯ç§’é˜é‡ç½®è¨ˆæ•¸å™¨

   æ™‚åºç¯„ä¾‹ï¼š
   00:00:00.0 - 00:00:00.9ï¼šæ¥æ”¶ 100 å€‹è«‹æ±‚ âœ…
   00:00:01.0ï¼šè¨ˆæ•¸å™¨é‡ç½®ç‚º 0
   00:00:01.0 - 00:00:01.1ï¼šæ¥æ”¶ 100 å€‹è«‹æ±‚ âœ…

   å•é¡Œï¼šé‚Šç•Œçªç™¼
   - 00:00:00.9 - 00:00:01.1 ä¹‹é–“ï¼ˆ0.2 ç§’ï¼‰
   - è™•ç†äº† 200 å€‹è«‹æ±‚ï¼ˆè¶…éé™åˆ¶ 2 å€ï¼‰âŒ

   è¨ˆç®—ï¼š
   - é™åˆ¶ï¼š100 req/s
   - æœ€å£æƒ…æ³ï¼š200 req/sï¼ˆé‚Šç•Œçªç™¼ï¼‰
   - èª¤å·®ï¼š100%

âŒ æ–¹æ¡ˆ Bï¼šLeaky Bucketï¼ˆæ¼æ¡¶ï¼‰
   æ©Ÿåˆ¶ï¼šè«‹æ±‚é€²å…¥æ¡¶ï¼Œä»¥å›ºå®šé€Ÿç‡æµå‡º

   æµç¨‹ï¼š
   1. è«‹æ±‚åˆ°é” â†’ åŠ å…¥éšŠåˆ—
   2. ä»¥å›ºå®šé€Ÿç‡è™•ç†è«‹æ±‚ï¼ˆå¦‚æ¯ 10ms è™•ç† 1 å€‹ï¼‰
   3. éšŠåˆ—æ»¿ â†’ æ‹’çµ•è«‹æ±‚

   å„ªå‹¢ï¼š
   - è¼¸å‡ºæµé‡å¹³æ»‘ï¼ˆåš´æ ¼æ§åˆ¶ï¼‰
   - é˜²æ­¢çªç™¼æ‰“åˆ°å¾Œç«¯

   å•é¡Œï¼š
   - å»¶é²å¢åŠ ï¼šè«‹æ±‚éœ€è¦æ’éšŠ
   - ä¸é©åˆéœ€è¦å³æ™‚éŸ¿æ‡‰çš„å ´æ™¯
   - å¯¦ç¾è¤‡é›œï¼šéœ€è¦å¾Œå°ä»»å‹™å®šæœŸæ¶ˆè²»

   ç¯„ä¾‹ï¼ˆä¸é©ç”¨ï¼‰ï¼š
   - é™åˆ¶ 100 req/s â†’ æ¯ 10ms è™•ç† 1 å€‹
   - çªç™¼ 10 å€‹è«‹æ±‚ â†’ éœ€è¦ç­‰å¾… 100ms
   - ç”¨æˆ¶é«”é©—å·®ï¼ˆå»¶é²é«˜ï¼‰

âœ… æ–¹æ¡ˆ Cï¼šToken Bucketï¼ˆä»¤ç‰Œæ¡¶ï¼‰â­
   æ©Ÿåˆ¶ï¼šæ¡¶å…§å­˜æ”¾ä»¤ç‰Œï¼Œä»¥å›ºå®šé€Ÿç‡å¡«å……

   æµç¨‹ï¼š
   1. æ¡¶ä»¥å›ºå®šé€Ÿç‡å¡«å……ä»¤ç‰Œï¼ˆå¦‚æ¯ç§’ 100 å€‹ï¼‰
   2. è«‹æ±‚åˆ°é” â†’ å˜—è©¦å–ä»¤ç‰Œ
   3. æœ‰ä»¤ç‰Œ â†’ å…è¨±è«‹æ±‚
   4. ç„¡ä»¤ç‰Œ â†’ æ‹’çµ•è«‹æ±‚

   å„ªå‹¢ï¼š
   - æ”¯æŒçªç™¼æµé‡ï¼šæ¡¶å…§å¯ç´¯ç©ä»¤ç‰Œï¼ˆå¦‚å®¹é‡ 200ï¼‰
   - å¯¦ç¾ç°¡å–®ï¼šåªéœ€è¨ˆæ™‚å™¨ + è¨ˆæ•¸å™¨
   - ç„¡å»¶é²ï¼šè«‹æ±‚ç«‹å³è™•ç†æˆ–æ‹’çµ•
   - æ€§èƒ½é«˜ï¼šO(1) æ™‚é–“è¤‡é›œåº¦

   çªç™¼è™•ç†ï¼š
   - æ¡¶å®¹é‡ï¼š200ï¼ˆå…è¨± 2x çªç™¼ï¼‰
   - å¡«å……é€Ÿç‡ï¼š100/s
   - å¹³æ™‚ç´¯ç©ä»¤ç‰Œï¼Œçªç™¼æ™‚å¯ç”¨

   æ¬Šè¡¡ï¼š
   - å…è¨±çŸ­æ™‚çªç™¼ï¼ˆç¬¦åˆå¯¦éš›éœ€æ±‚ï¼‰
   - é•·æœŸå¹³å‡æµé‡ä»è¢«é™åˆ¶

âœ… æ–¹æ¡ˆ Dï¼šSliding Windowï¼ˆæ»‘å‹•çª—å£ï¼‰â­
   æ©Ÿåˆ¶ï¼šçµ±è¨ˆæ»‘å‹•æ™‚é–“çª—å£å…§çš„è«‹æ±‚æ•¸

   æµç¨‹ï¼š
   1. è¨˜éŒ„æ¯å€‹è«‹æ±‚çš„æ™‚é–“æˆ³
   2. çµ±è¨ˆéå» N ç§’å…§çš„è«‹æ±‚æ•¸
   3. è¶…éé™åˆ¶ â†’ æ‹’çµ•

   å„ªå‹¢ï¼š
   - ç²¾ç¢ºé™æµï¼šç„¡é‚Šç•Œçªç™¼å•é¡Œ
   - ç¬¦åˆç›´è¦ºï¼šä»»æ„ 1 ç§’å…§æœ€å¤š 100 å€‹

   å•é¡Œï¼š
   - å…§å­˜å ç”¨é«˜ï¼šéœ€å­˜å„²æ‰€æœ‰æ™‚é–“æˆ³
   - æ€§èƒ½ç•¥ä½ï¼šéœ€éæ­·æ¸…ç†éæœŸè«‹æ±‚

   å…§å­˜ä¼°ç®—ï¼š
   - é™åˆ¶ 1000 req/s
   - æ¯å€‹æ™‚é–“æˆ³ 24 bytes
   - å…§å­˜ï¼š1000 Ã— 24 = 24 KBï¼ˆå¯æ¥å—ï¼‰

   å„ªåŒ–ï¼šSliding Window Counter
   - å°‡çª—å£åˆ†æ®µï¼ˆå¦‚ 60 å€‹ 1 ç§’æ¡¶ï¼‰
   - åªå­˜å„²è¨ˆæ•¸å™¨ï¼ˆè€Œéæ¯å€‹æ™‚é–“æˆ³ï¼‰
   - å…§å­˜ï¼š60 Ã— 8 bytes = 480 bytes
   - ç²¾åº¦ç•¥é™ï¼Œä½†è¶³å¤ å¯¦ç”¨
```

**é¸æ“‡ï¼šToken Bucketï¼ˆé€šç”¨å ´æ™¯ï¼‰+ Sliding Windowï¼ˆç²¾ç¢ºé™æµå ´æ™¯ï¼‰**

**å¯¦ç¾ç´°ç¯€ï¼š**
```go
// Token Bucket
type TokenBucket struct {
    capacity   int64         // æ¡¶å®¹é‡ï¼ˆæ”¯æŒçªç™¼ï¼‰
    tokens     int64         // ç•¶å‰ä»¤ç‰Œæ•¸
    refillRate int64         // å¡«å……é€Ÿç‡ï¼ˆæ¯ç§’ï¼‰
    lastRefill time.Time     // ä¸Šæ¬¡å¡«å……æ™‚é–“
}

func (tb *TokenBucket) Allow() bool {
    // è¨ˆç®—æ‡‰å¡«å……çš„ä»¤ç‰Œæ•¸
    elapsed := time.Since(tb.lastRefill).Seconds()
    tokensToAdd := int64(elapsed * float64(tb.refillRate))

    // å¡«å……ä»¤ç‰Œï¼ˆä¸è¶…éå®¹é‡ï¼‰
    tb.tokens = min(tb.capacity, tb.tokens + tokensToAdd)
    tb.lastRefill = time.Now()

    // å˜—è©¦å–ä»¤ç‰Œ
    if tb.tokens > 0 {
        tb.tokens--
        return true
    }
    return false
}

// Sliding Window
type SlidingWindow struct {
    requests []time.Time    // è«‹æ±‚æ™‚é–“æˆ³åˆ—è¡¨
    limit    int64          // é™åˆ¶
    window   time.Duration  // çª—å£å¤§å°
}

func (sw *SlidingWindow) Allow() bool {
    now := time.Now()
    windowStart := now.Add(-sw.window)

    // æ¸…ç†éæœŸè«‹æ±‚
    validIdx := 0
    for i, t := range sw.requests {
        if t.After(windowStart) {
            validIdx = i
            break
        }
    }
    sw.requests = sw.requests[validIdx:]

    // æª¢æŸ¥é™åˆ¶
    if len(sw.requests) < int(sw.limit) {
        sw.requests = append(sw.requests, now)
        return true
    }
    return false
}
```

---

### æ±ºç­– 2ï¼šå–®æ©Ÿ vs åˆ†å¸ƒå¼é™æµï¼Ÿ

```
å•é¡Œï¼šå¤šå€‹æœå‹™å¯¦ä¾‹å¦‚ä½•å…±äº«é™æµç‹€æ…‹ï¼Ÿ

å ´æ™¯ï¼š3 å€‹æœå‹™å¯¦ä¾‹ï¼Œé™åˆ¶ 300 req/s

âŒ æ–¹æ¡ˆ Aï¼šæ¯å€‹å¯¦ä¾‹ç¨ç«‹é™æµï¼ˆ100 req/sï¼‰
   å•é¡Œï¼š
   - è² è¼‰ä¸å‡æ™‚å¤±æ•ˆï¼š
     - å¯¦ä¾‹ 1ï¼š50 req/sï¼ˆé™åˆ¶ 100ï¼Œé€šéï¼‰
     - å¯¦ä¾‹ 2ï¼š50 req/sï¼ˆé™åˆ¶ 100ï¼Œé€šéï¼‰
     - å¯¦ä¾‹ 3ï¼š250 req/sï¼ˆé™åˆ¶ 100ï¼Œæ‹’çµ• 150ï¼‰
     - ç¸½è¨ˆï¼š350 req/sï¼ˆè¶…é 300ï¼‰âŒ

   - å‹•æ…‹æ“´ç¸®å®¹å•é¡Œï¼š
     - æ“´å®¹åˆ° 4 å€‹å¯¦ä¾‹ â†’ é™åˆ¶è®Šç‚º 400 req/s
     - ç¸®å®¹åˆ° 2 å€‹å¯¦ä¾‹ â†’ é™åˆ¶è®Šç‚º 200 req/s
     - éœ€è¦å‹•æ…‹èª¿æ•´æ¯å€‹å¯¦ä¾‹çš„é™åˆ¶

âœ… æ–¹æ¡ˆ Bï¼šåˆ†å¸ƒå¼é™æµï¼ˆRedis é›†ä¸­å­˜å„²ï¼‰
   æ©Ÿåˆ¶ï¼š
   - æ‰€æœ‰å¯¦ä¾‹å…±äº« Redis ä¸­çš„è¨ˆæ•¸å™¨
   - ä½¿ç”¨ Lua è…³æœ¬ä¿è­‰åŸå­æ€§

   æµç¨‹ï¼š
   1. è«‹æ±‚åˆ°é”å¯¦ä¾‹ 1
   2. å¯¦ä¾‹ 1 èª¿ç”¨ Redis Lua è…³æœ¬
   3. Lua è…³æœ¬åŸå­æ€§åœ°ï¼š
      - æª¢æŸ¥ç•¶å‰è¨ˆæ•¸
      - è¨ˆæ•¸ +1ï¼ˆå¦‚æœæœªè¶…é™ï¼‰
      - è¿”å›æ˜¯å¦å…è¨±
   4. å¯¦ä¾‹æ ¹æ“šçµæœè™•ç†è«‹æ±‚

   å„ªå‹¢ï¼š
   - å…¨å±€æº–ç¢ºï¼šæ‰€æœ‰å¯¦ä¾‹å…±äº«ç‹€æ…‹
   - å‹•æ…‹æ“´ç¸®å®¹å‹å¥½ï¼šç„¡éœ€èª¿æ•´é…ç½®
   - å¯¦ç¾ç›¸å°ç°¡å–®

   æ¬Šè¡¡ï¼š
   - å»¶é²å¢åŠ ï¼šéœ€è¦ç¶²çµ¡èª¿ç”¨ Redisï¼ˆ~1-2msï¼‰
   - å–®é»ä¾è³´ï¼šRedis æ•…éšœå½±éŸ¿é™æµ
   - æˆæœ¬ï¼šéœ€è¦ Redis åŸºç¤è¨­æ–½

æ–¹æ¡ˆ Cï¼šæœ¬åœ°é™æµ + å®šæœŸåŒæ­¥ï¼ˆæ··åˆï¼‰
   æ©Ÿåˆ¶ï¼š
   - æ¯å€‹å¯¦ä¾‹ç¶­è­·æœ¬åœ°è¨ˆæ•¸å™¨
   - å®šæœŸï¼ˆå¦‚æ¯ 100msï¼‰åŒæ­¥åˆ° Redis
   - æ ¹æ“šå…¨å±€ç‹€æ…‹èª¿æ•´æœ¬åœ°é™åˆ¶

   å„ªå‹¢ï¼š
   - ä½å»¶é²ï¼šå¤§éƒ¨åˆ†è«‹æ±‚åªæŸ¥æœ¬åœ°
   - æ¸›å°‘ Redis å£“åŠ›ï¼šåŒæ­¥é »ç‡ä½

   å•é¡Œï¼š
   - ç²¾åº¦é™ä½ï¼š100ms å…§å¯èƒ½è¶…é™
   - å¯¦ç¾è¤‡é›œï¼šéœ€è¦å”èª¿é‚è¼¯
   - é©ç”¨å ´æ™¯æœ‰é™ï¼šå°ç²¾åº¦è¦æ±‚ä¸é«˜æ™‚
```

**é¸æ“‡ï¼šæ–¹æ¡ˆ Bï¼ˆåˆ†å¸ƒå¼é™æµï¼‰ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒ**
**æ•™å­¸å¯¦ç¾ï¼šæ–¹æ¡ˆ Aï¼ˆå–®æ©Ÿï¼‰+ æ–¹æ¡ˆ Bï¼ˆåˆ†å¸ƒå¼ï¼‰éƒ½å±•ç¤º**

**Redis + Lua å¯¦ç¾ï¼š**
```lua
-- Redis Lua è…³æœ¬ï¼ˆToken Bucketï¼‰
local key = KEYS[1]
local capacity = tonumber(ARGV[1])
local rate = tonumber(ARGV[2])
local now = tonumber(ARGV[3])

-- ç²å–ç•¶å‰ç‹€æ…‹
local state = redis.call('HMGET', key, 'tokens', 'last_refill')
local tokens = tonumber(state[1]) or capacity
local last_refill = tonumber(state[2]) or now

-- è¨ˆç®—å¡«å……ä»¤ç‰Œ
local elapsed = now - last_refill
local tokens_to_add = math.floor(elapsed * rate)
tokens = math.min(capacity, tokens + tokens_to_add)

-- å˜—è©¦å–ä»¤ç‰Œ
local allowed = 0
if tokens > 0 then
    tokens = tokens - 1
    allowed = 1
end

-- æ›´æ–°ç‹€æ…‹
redis.call('HMSET', key, 'tokens', tokens, 'last_refill', now)
redis.call('EXPIRE', key, 60)  -- 60 ç§’éæœŸ

return allowed
```

---

### æ±ºç­– 3ï¼šå¦‚ä½•è™•ç†é™æµç¶­åº¦ï¼Ÿ

```
å•é¡Œï¼šéœ€è¦æŒ‰ä¸åŒç¶­åº¦é™æµï¼ˆIPã€ç”¨æˆ¶ã€API ç«¯é»ï¼‰

å ´æ™¯ï¼š
- å…è²»ç”¨æˆ¶ï¼š100 req/hourï¼ˆæŒ‰ç”¨æˆ¶ IDï¼‰
- å–®å€‹ IPï¼š1000 req/hourï¼ˆé˜²æ­¢ DDoSï¼‰
- ç™»éŒ„æ¥å£ï¼š5 req/minï¼ˆæŒ‰ IPï¼Œé˜²æš´åŠ›ç ´è§£ï¼‰

âŒ æ–¹æ¡ˆ Aï¼šå–®ä¸€ç¶­åº¦é™æµ
   å•é¡Œï¼šç„¡æ³•æ»¿è¶³å¤šç¶­åº¦éœ€æ±‚

âœ… æ–¹æ¡ˆ Bï¼šå¤šç¶­åº¦é™æµï¼ˆçµ„åˆ keyï¼‰
   æ©Ÿåˆ¶ï¼šæ ¹æ“šä¸åŒç¶­åº¦çµ„åˆ key

   Key è¨­è¨ˆï¼š
   - ç”¨æˆ¶é™æµï¼šratelimit:user:{user_id}
   - IP é™æµï¼šratelimit:ip:{ip_address}
   - API é™æµï¼šratelimit:api:{endpoint}
   - çµ„åˆé™æµï¼šratelimit:user:{user_id}:api:{endpoint}

   ç¯„ä¾‹ï¼š
   POST /api/uploadï¼Œç”¨æˆ¶ user_123ï¼ŒIP 1.2.3.4

   éœ€è¦æª¢æŸ¥ï¼š
   1. ratelimit:user:user_123 â†’ ç”¨æˆ¶ç¸½é™åˆ¶
   2. ratelimit:ip:1.2.3.4 â†’ IP é™åˆ¶
   3. ratelimit:api:/api/upload â†’ API é™åˆ¶

   åªæœ‰éƒ½é€šéæ‰å…è¨±è«‹æ±‚

   å„ªå‹¢ï¼š
   - éˆæ´»ï¼šå¯æŒ‰éœ€çµ„åˆ
   - ç²¾ç´°æ§åˆ¶ï¼šä¸åŒå ´æ™¯ä¸åŒç­–ç•¥

   æ¬Šè¡¡ï¼š
   - å»¶é²å¢åŠ ï¼šéœ€è¦å¤šæ¬¡æª¢æŸ¥
   - è¤‡é›œåº¦é«˜ï¼šéœ€è¦å”èª¿å¤šå€‹é™æµå™¨

å„ªåŒ–ï¼šçŸ­è·¯æ±‚å€¼
   æ©Ÿåˆ¶ï¼šæŒ‰åš´æ ¼ç¨‹åº¦æ’åºï¼Œå„ªå…ˆæª¢æŸ¥

   ç¯„ä¾‹ï¼š
   - IP é™æµï¼š1000 req/hourï¼ˆæœ€å¯¬é¬†ï¼‰
   - ç”¨æˆ¶é™æµï¼š100 req/hourï¼ˆæ¬¡åš´æ ¼ï¼‰
   - API é™æµï¼š10 req/hourï¼ˆæœ€åš´æ ¼ï¼‰

   æª¢æŸ¥é †åºï¼šAPI â†’ ç”¨æˆ¶ â†’ IP
   - å¦‚æœ API é™æµå·²è§¸ç™¼ï¼Œç›´æ¥æ‹’çµ•ï¼ˆç„¡éœ€æª¢æŸ¥å…¶ä»–ï¼‰
   - æ¸›å°‘ä¸å¿…è¦çš„ Redis èª¿ç”¨
```

**é¸æ“‡ï¼šå¤šç¶­åº¦é™æµ + çŸ­è·¯å„ªåŒ–**

**å¯¦ç¾ç´°ç¯€ï¼š**
```go
type RateLimiter struct {
    limiters map[string]*TokenBucket
}

func (rl *RateLimiter) Allow(ctx Context) bool {
    // æª¢æŸ¥å¤šå€‹ç¶­åº¦ï¼ˆæŒ‰åš´æ ¼ç¨‹åº¦æ’åºï¼‰
    checks := []struct{
        key string
        limiter *TokenBucket
    }{
        {"api:" + ctx.Endpoint, rl.limiters["api"]},
        {"user:" + ctx.UserID, rl.limiters["user"]},
        {"ip:" + ctx.IP, rl.limiters["ip"]},
    }

    for _, check := range checks {
        if !check.limiter.Allow() {
            return false  // çŸ­è·¯ï¼šä»»ä¸€ç¶­åº¦è¶…é™ï¼Œç›´æ¥æ‹’çµ•
        }
    }
    return true
}
```

---

### æ±ºç­– 4ï¼šå¦‚ä½•è™•ç†é™æµå¤±æ•—ï¼Ÿ

```
å•é¡Œï¼šè«‹æ±‚è¢«é™æµæ™‚å¦‚ä½•è™•ç†ï¼Ÿ

âŒ æ–¹æ¡ˆ Aï¼šç›´æ¥è¿”å› 429
   å•é¡Œï¼šç”¨æˆ¶é«”é©—å·®ï¼Œç„¡æ³•é ä¼°æ¢å¾©æ™‚é–“

âœ… æ–¹æ¡ˆ Bï¼šè¿”å› 429 + Retry-After header
   æ©Ÿåˆ¶ï¼šå‘Šè¨´å®¢æˆ¶ç«¯ä½•æ™‚å¯ä»¥é‡è©¦

   HTTP éŸ¿æ‡‰ï¼š
   HTTP/1.1 429 Too Many Requests
   Retry-After: 60
   X-RateLimit-Limit: 100
   X-RateLimit-Remaining: 0
   X-RateLimit-Reset: 1609459200

   Body:
   {
     "error": "Rate limit exceeded",
     "retry_after": 60
   }

   å„ªå‹¢ï¼š
   - å®¢æˆ¶ç«¯å¯ä»¥è‡ªå‹•é‡è©¦
   - é¿å…ç„¡æ„ç¾©çš„é‡è¤‡è«‹æ±‚

æ–¹æ¡ˆ Cï¼šè«‹æ±‚æ’éšŠï¼ˆLeaky Bucketï¼‰
   å•é¡Œï¼šå¢åŠ å»¶é²ï¼Œä¸é©åˆå¯¦æ™‚å ´æ™¯

æ–¹æ¡ˆ Dï¼šé™ç´šè™•ç†
   æ©Ÿåˆ¶ï¼š
   - é™æµæ™‚è¿”å›ç·©å­˜æ•¸æ“šï¼ˆå¦‚æœå¯ä»¥ï¼‰
   - æˆ–è¿”å›ç°¡åŒ–ç‰ˆæœ¬ï¼ˆæ¸›å°‘è¨ˆç®—ï¼‰

   ç¯„ä¾‹ï¼š
   - æ­£å¸¸ï¼šè¿”å›å€‹æ€§åŒ–æ¨è–¦ï¼ˆéœ€è¦è¨ˆç®—ï¼‰
   - é™æµæ™‚ï¼šè¿”å›ç†±é–€æ¨è–¦ï¼ˆç·©å­˜ï¼‰
```

**é¸æ“‡ï¼šæ–¹æ¡ˆ Bï¼ˆæ¨™æº–éŸ¿æ‡‰ï¼‰+ æ–¹æ¡ˆ Dï¼ˆé™ç´šï¼Œå¯é¸ï¼‰**

---

## ğŸ“ˆ æ“´å±•æ€§åˆ†æ

### ç•¶å‰æ¶æ§‹å®¹é‡

```
å–®æ©Ÿé™æµï¼š
- ç®—æ³•ï¼šToken Bucketï¼ˆå…§å­˜ï¼‰
- æ€§èƒ½ï¼š100K RPS
- å»¶é²ï¼š< 1ms
- é©ç”¨ï¼šå–®å¯¦ä¾‹æœå‹™

åˆ†å¸ƒå¼é™æµï¼š
- å­˜å„²ï¼šRedis
- æ€§èƒ½ï¼š50K RPSï¼ˆå— Redis é™åˆ¶ï¼‰
- å»¶é²ï¼š< 5msï¼ˆç¶²çµ¡é–‹éŠ·ï¼‰
- é©ç”¨ï¼šå¤šå¯¦ä¾‹æœå‹™

çµè«–ï¼šå–®æ©Ÿè¶³å¤ æ”¯æ’å¤§éƒ¨åˆ†å ´æ™¯
```

### 10x æ“´å±•ï¼ˆ500K RPSï¼‰

```
ç“¶é ¸åˆ†æï¼š
âŒ Redis å–®å¯¦ä¾‹ï¼š~80K RPS æ¥µé™
âŒ ç¶²çµ¡å»¶é²ï¼šæ¯æ¬¡æª¢æŸ¥ ~2ms

æ–¹æ¡ˆ 1ï¼šRedis ä¸»å¾è¤‡è£½
- è®€å¯«åˆ†é›¢ï¼šè®€å¾åº«ï¼Œå¯«ä¸»åº«
- å•é¡Œï¼šé™æµéœ€è¦è®€å¯«åŸå­æ€§ï¼ˆä¸é©ç”¨ï¼‰

æ–¹æ¡ˆ 2ï¼šRedis Cluster åˆ†ç‰‡
- æŒ‰ key åˆ†ç‰‡ï¼ˆå¦‚æŒ‰ç”¨æˆ¶ ID hashï¼‰
- 16 å€‹ shard Ã— 50K RPS = 800K RPS
- æˆæœ¬ï¼š$1,600/æœˆï¼ˆ16 å€‹ Redis å¯¦ä¾‹ï¼‰

æ–¹æ¡ˆ 3ï¼šæœ¬åœ°é™æµ + å®šæœŸåŒæ­¥
- 99% è«‹æ±‚æŸ¥æœ¬åœ°ï¼ˆ< 1msï¼‰
- 1% åŒæ­¥åˆ° Redisï¼ˆæ›´æ–°å…¨å±€ç‹€æ…‹ï¼‰
- ç²¾åº¦ç•¥é™ï¼ˆ~5% èª¤å·®ï¼‰ï¼Œæ€§èƒ½å¤§å¹…æå‡
- æˆæœ¬ï¼šç„¡éœ€é¡å¤–åŸºç¤è¨­æ–½

æ¨è–¦ï¼šæ–¹æ¡ˆ 3ï¼ˆç²¾åº¦è¦æ±‚ä¸æ¥µè‡´æ™‚ï¼‰
```

### 100x æ“´å±•ï¼ˆ5M RPSï¼‰

```
éœ€è¦æ¶æ§‹å‡ç´šï¼š

1. åˆ†å±¤é™æµ
   - L1ï¼šæœ¬åœ°å…§å­˜ï¼ˆ99.9% è«‹æ±‚ï¼‰
   - L2ï¼šRedisï¼ˆ0.1% åŒæ­¥ï¼‰
   - L3ï¼šè³‡æ–™åº«ï¼ˆæŒä¹…åŒ–é…é¡ï¼‰

2. é™æµç­–ç•¥å„ªåŒ–
   - ç²—ç²’åº¦é™æµï¼šæŒ‰ IP æ®µè€Œéå–® IP
   - é åˆ†é…é…é¡ï¼šæ¯å€‹å¯¦ä¾‹é ˜å–ä¸€æ‰¹é…é¡
   - å®šæœŸçµç®—ï¼šé¿å…å¯¦æ™‚åŒæ­¥

3. åˆ†å¸ƒå¼é…é¡ç®¡ç†
   æ¶æ§‹ï¼š
   Client Request
     â†“
   API Gateway (L1: æœ¬åœ°é™æµ)
     â†“
   Quota Service (L2: Redis Cluster)
     â†“
   Billing DB (L3: æŒä¹…åŒ–)

   æµç¨‹ï¼š
   - API Gateway æ¯ 10 ç§’å‘ Quota Service ç”³è«‹é…é¡
   - Quota Service å¾ Redis åˆ†é…é…é¡
   - Redis å®šæœŸåŒæ­¥åˆ° Billing DB

   å„ªå‹¢ï¼š
   - æ¥µä½å»¶é²ï¼šæœ¬åœ°é™æµ < 1ms
   - é«˜ååï¼šæ¸›å°‘ 99.9% çš„é ç¨‹èª¿ç”¨
   - å¯æ§èª¤å·®ï¼šé…é¡çª—å£å…§ï¼ˆ10 ç§’ï¼‰å¯èƒ½è¶…é™ ~5%

4. æˆæœ¬ä¼°ç®—
   - API Gatewayï¼š100 å¯¦ä¾‹ Ã— $50 = $5,000/æœˆ
   - Redis Clusterï¼š32 shard Ã— $100 = $3,200/æœˆ
   - Quota Serviceï¼š10 å¯¦ä¾‹ Ã— $100 = $1,000/æœˆ
   - ç¸½è¨ˆï¼š~$9,200/æœˆ
```

---

## ğŸ”§ å¯¦ç¾ç¯„åœæ¨™è¨»

### âœ… å·²å¯¦ç¾ï¼ˆæ ¸å¿ƒæ•™å­¸å…§å®¹ï¼‰

| åŠŸèƒ½ | æª”æ¡ˆ | æ•™å­¸é‡é» |
|------|------|----------|
| **Token Bucket** | `tokenbucket.go:37-111` | çªç™¼æµé‡è™•ç†ã€ä»¤ç‰Œå¡«å……ç®—æ³• |
| **Sliding Window** | `slidingwindow.go:42-127` | ç²¾ç¢ºé™æµã€é‚Šç•Œå•é¡Œè§£æ±º |
| **Leaky Bucket** | `leakybucket.go` | å¹³æ»‘è¼¸å‡ºã€éšŠåˆ—è™•ç† |
| **ä¸¦ç™¼å®‰å…¨** | å„ç®—æ³• `sync.Mutex` | äº’æ–¥é–ä¿è­· |

### âš ï¸ æ•™å­¸ç°¡åŒ–ï¼ˆæœªå¯¦ç¾ï¼‰

| åŠŸèƒ½ | åŸå›  | ç”Ÿç”¢ç’°å¢ƒå»ºè­° |
|------|------|-------------|
| **åˆ†å¸ƒå¼é™æµ** | èšç„¦ç®—æ³•æœ¬èº« | Redis + Lua è…³æœ¬ä¿è­‰åŸå­æ€§ |
| **å¤šç¶­åº¦é™æµ** | ç°¡åŒ–ç¤ºç¯„ | æŒ‰ IPã€ç”¨æˆ¶ã€API çµ„åˆé™æµ |
| **é…é¡ç®¡ç†** | å¢åŠ è¤‡é›œåº¦ | é åˆ†é…é…é¡ + å®šæœŸçµç®— |
| **é™ç´šè™•ç†** | æ¥­å‹™é‚è¼¯ç›¸é—œ | é™æµæ™‚è¿”å›ç·©å­˜æ•¸æ“š |

### ğŸš€ ç”Ÿç”¢ç’°å¢ƒé¡å¤–éœ€è¦

```
1. åˆ†å¸ƒå¼é™æµ
   - Redis Clusterï¼šåˆ†ç‰‡æå‡æ€§èƒ½
   - Lua è…³æœ¬ï¼šä¿è­‰æ“ä½œåŸå­æ€§
   - é€£æ¥æ± ï¼šæ¸›å°‘é€£æ¥é–‹éŠ·
   - ç†”æ–·å™¨ï¼šRedis æ•…éšœæ™‚é™ç´š

2. ç›£æ§å‘Šè­¦
   - é™æµè§¸ç™¼ç‡ï¼šæ¯ç§’è¢«æ‹’çµ•çš„è«‹æ±‚æ•¸
   - å„ç¶­åº¦çµ±è¨ˆï¼šIP/ç”¨æˆ¶/API åˆ†åˆ¥çµ±è¨ˆ
   - ç•°å¸¸æª¢æ¸¬ï¼šçªç„¶å¤§é‡é™æµå‘Šè­¦
   - é…é¡ä½¿ç”¨ï¼šå¯¦æ™‚ç›£æ§é…é¡æ¶ˆè€—

3. å‹•æ…‹é…ç½®
   - ç†±æ›´æ–°ï¼šç„¡éœ€é‡å•Ÿä¿®æ”¹é™æµè¦å‰‡
   - A/B æ¸¬è©¦ï¼šä¸åŒç”¨æˆ¶ä¸åŒé™åˆ¶
   - ç™½åå–®ï¼šç‰¹å®šç”¨æˆ¶å…é™æµ
   - ç·Šæ€¥é–‹é—œï¼šå¿«é€Ÿé—œé–‰é™æµï¼ˆæ‡‰æ€¥ï¼‰

4. é«˜ç´šåŠŸèƒ½
   - ä»¤ç‰Œé å€Ÿï¼šå…è¨±é€æ”¯ï¼ˆå¾ŒçºŒæ‰£é™¤ï¼‰
   - å„ªå…ˆç´šéšŠåˆ—ï¼šé‡è¦è«‹æ±‚å„ªå…ˆè™•ç†
   - å¹³æ»‘æ“´å®¹ï¼šæ–°å¯¦ä¾‹é€æ­¥æ¥ç®¡æµé‡
   - è·¨æ©Ÿæˆ¿åŒæ­¥ï¼šå¤šæ©Ÿæˆ¿é…é¡å…±äº«

5. å®¢æˆ¶ç«¯å„ªåŒ–
   - æŒ‡æ•¸é€€é¿ï¼šé™æµå¾Œå»¶é²é‡è©¦
   - æœ¬åœ°é™æµï¼šå®¢æˆ¶ç«¯é æª¢ï¼Œæ¸›å°‘ç„¡æ•ˆè«‹æ±‚
   - æ‰¹é‡è«‹æ±‚ï¼šåˆä½µå¤šå€‹è«‹æ±‚æ¸›å°‘æ¬¡æ•¸
```

---

## ğŸ’¡ é—œéµè¨­è¨ˆåŸå‰‡ç¸½çµ

### 1. Token Bucketï¼ˆæ”¯æŒçªç™¼ï¼‰
```
ä»¤ç‰Œæ¡¶ vs æ¼æ¡¶ï¼š
- ä»¤ç‰Œæ¡¶ï¼šå…è¨±çªç™¼ï¼Œé©åˆå¤§éƒ¨åˆ†å ´æ™¯
- æ¼æ¡¶ï¼šåš´æ ¼å¹³æ»‘ï¼Œé©åˆéœ€è¦æ†å®šé€Ÿç‡çš„å ´æ™¯

å®¹é‡è¨­è¨ˆï¼š
- å¹³å‡æµé‡ï¼š100 req/s
- çªç™¼å®¹é‡ï¼š200ï¼ˆ2x å¹³å‡ï¼‰
- å¡«å……é€Ÿç‡ï¼š100 ä»¤ç‰Œ/s

çªç™¼è™•ç†ï¼š
- å¹³æ™‚ç´¯ç©ä»¤ç‰Œï¼ˆæœ€å¤š 200 å€‹ï¼‰
- çªç™¼æ™‚æ¶ˆè€—ç´¯ç©çš„ä»¤ç‰Œ
- é•·æœŸå¹³å‡ä»æ˜¯ 100 req/s
```

### 2. Sliding Windowï¼ˆç²¾ç¢ºé™æµï¼‰
```
å›ºå®šçª—å£ vs æ»‘å‹•çª—å£ï¼š
- å›ºå®šçª—å£ï¼šé‚Šç•Œçªç™¼å•é¡Œï¼ˆæœ€å£ 2xï¼‰
- æ»‘å‹•çª—å£ï¼šç²¾ç¢ºæ§åˆ¶ï¼Œç„¡é‚Šç•Œå•é¡Œ

å…§å­˜å„ªåŒ–ï¼š
- ç²¾ç¢ºç‰ˆï¼šå­˜å„²æ‰€æœ‰æ™‚é–“æˆ³ï¼ˆ24 KB/1000 reqï¼‰
- è¨ˆæ•¸å™¨ç‰ˆï¼šåˆ†æ®µè¨ˆæ•¸ï¼ˆ480 bytes/60 æ®µï¼‰
- æ¬Šè¡¡ï¼šç²¾åº¦ vs å…§å­˜

é©ç”¨å ´æ™¯ï¼š
- éœ€è¦ç²¾ç¢ºé™æµï¼ˆå¦‚ä»˜è²» APIï¼‰
- QPS ä¸æ˜¯æ¥µé«˜ï¼ˆ< 10Kï¼‰
```

### 3. åˆ†å¸ƒå¼é™æµï¼ˆå…¨å±€ä¸€è‡´ï¼‰
```
å–®æ©Ÿ vs åˆ†å¸ƒå¼ï¼š
- å–®æ©Ÿï¼šä½å»¶é²ï¼ˆ< 1msï¼‰ï¼Œä½†ç„¡æ³•å…±äº«
- åˆ†å¸ƒå¼ï¼šå…¨å±€æº–ç¢ºï¼Œå»¶é²å¢åŠ ï¼ˆ~5msï¼‰

Redis + Luaï¼š
- åŸå­æ€§ï¼šæ•´å€‹è…³æœ¬åŸå­åŸ·è¡Œ
- æ¸›å°‘ç¶²çµ¡ï¼šå¤šå€‹æ“ä½œä¸€æ¬¡èª¿ç”¨
- æ€§èƒ½ï¼š~50K RPSï¼ˆå–®å¯¦ä¾‹ï¼‰

æ··åˆæ–¹æ¡ˆï¼š
- æœ¬åœ°é™æµï¼š99% è«‹æ±‚
- å®šæœŸåŒæ­¥ï¼š1% è«‹æ±‚åŒæ­¥åˆ° Redis
- ç²¾åº¦ç•¥é™ï¼ˆ~5%ï¼‰ï¼Œæ€§èƒ½å¤§å¹…æå‡
```

### 4. å¤šç¶­åº¦é™æµï¼ˆéˆæ´»æ§åˆ¶ï¼‰
```
ç¶­åº¦çµ„åˆï¼š
- æŒ‰ç”¨æˆ¶ï¼šé˜²æ­¢å–®ç”¨æˆ¶æ¿«ç”¨
- æŒ‰ IPï¼šé˜²æ­¢ DDoS
- æŒ‰ APIï¼šä¿è­·é—œéµæ¥å£

çŸ­è·¯å„ªåŒ–ï¼š
- æŒ‰åš´æ ¼ç¨‹åº¦æ’åº
- å„ªå…ˆæª¢æŸ¥æœ€åš´æ ¼çš„
- ä»»ä¸€ç¶­åº¦è¶…é™ï¼Œç›´æ¥æ‹’çµ•

Key è¨­è¨ˆï¼š
ratelimit:{dimension}:{value}:{window}
ä¾‹å¦‚ï¼šratelimit:user:123:hour
```

---

## ğŸ“š å»¶ä¼¸é–±è®€

### ç›¸é—œç³»çµ±è¨­è¨ˆå•é¡Œ
- å¦‚ä½•è¨­è¨ˆä¸€å€‹ **API Gateway**ï¼Ÿï¼ˆé™æµæ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
- å¦‚ä½•è¨­è¨ˆä¸€å€‹ **DDoS é˜²è­·ç³»çµ±**ï¼Ÿï¼ˆå¤§è¦æ¨¡é™æµï¼‰
- å¦‚ä½•è¨­è¨ˆä¸€å€‹ **ç§’æ®ºç³»çµ±**ï¼Ÿï¼ˆæ¥µç«¯æµé‡é™åˆ¶ï¼‰

### é™æµç®—æ³•è©³è§£
- **Token Bucket**ï¼šGoogle Guava RateLimiter
- **Leaky Bucket**ï¼šNginx é™æµæ¨¡å¡Š
- **Sliding Window**ï¼šRedis ZSET å¯¦ç¾
- **å›ºå®šçª—å£**ï¼šRedis INCR + EXPIRE

### å·¥æ¥­å¯¦ç¾åƒè€ƒ
- **Nginx limit_req**: åŸºæ–¼ Leaky Bucket
- **Kong Rate Limiting**: æ”¯æŒå¤šç¨®ç®—æ³•
- **AWS API Gateway**: Token Bucket
- **Google Cloud Armor**: åˆ†å¸ƒå¼é™æµ

---

## ğŸ¯ ç¸½çµ

Rate Limiter å±•ç¤ºäº†**æµé‡æ§åˆ¶**çš„ç¶“å…¸è¨­è¨ˆæ¨¡å¼ï¼š

1. **Token Bucket**ï¼šæ”¯æŒçªç™¼ï¼Œé©åˆé€šç”¨å ´æ™¯
2. **Sliding Window**ï¼šç²¾ç¢ºé™æµï¼Œç„¡é‚Šç•Œå•é¡Œ
3. **åˆ†å¸ƒå¼é™æµ**ï¼šRedis + Lua ä¿è­‰å…¨å±€ä¸€è‡´
4. **å¤šç¶­åº¦é™æµ**ï¼šéˆæ´»çµ„åˆï¼Œç²¾ç´°æ§åˆ¶

**æ ¸å¿ƒæ€æƒ³ï¼š** ç”¨ä»¤ç‰Œæ¡¶è™•ç†çªç™¼æµé‡ï¼Œç”¨æ»‘å‹•çª—å£ä¿è­‰ç²¾ç¢ºæ€§ï¼Œç”¨ Redis å¯¦ç¾åˆ†å¸ƒå¼ï¼Œç”¨å¤šç¶­åº¦çµ„åˆå¯¦ç¾éˆæ´»æ§åˆ¶ã€‚

**é©ç”¨å ´æ™¯ï¼š** API é™æµã€DDoS é˜²è­·ã€ç§’æ®ºç³»çµ±ã€é˜²æš´åŠ›ç ´è§£ã€è³‡æºé…é¡ç®¡ç†

**ä¸é©ç”¨ï¼š** ä¸éœ€è¦é™æµçš„å…§éƒ¨æœå‹™ã€å·²æœ‰è² è¼‰å‡è¡¡çš„å ´æ™¯

**èˆ‡å…¶ä»–æœå‹™å°æ¯”ï¼š**
| ç¶­åº¦ | Rate Limiter | URL Shortener | Counter Service |
|------|--------------|---------------|-----------------|
| **æ ¸å¿ƒæŒ‘æˆ°** | æµé‡æ§åˆ¶ | å…¨å±€å”¯ä¸€ ID | é«˜é »å¯«å…¥ |
| **æ™‚é–“çª—å£** | ç§’ç´š/åˆ†é˜ç´š | ç„¡ | å°æ™‚ç´š/å¤©ç´š |
| **ç²¾åº¦è¦æ±‚** | é«˜ï¼ˆ< 5%ï¼‰ | çµ•å°ï¼ˆ100%ï¼‰ | å¯æ¥å—ï¼ˆ~1%ï¼‰ |
| **åˆ†å¸ƒå¼** | Redis + Lua | Snowflake | Redis + PG |
| **å»¶é²è¦æ±‚** | < 5ms | < 10ms | < 50ms |
