# Search Autocomplete ç³»çµ±è¨­è¨ˆæ–‡æª”

## é€±ä¸€æ—©ä¸Šçš„ç”¢å“è©•å¯©æœƒè­°

2024 å¹´ 5 æœˆ 6 æ—¥ä¸Šåˆ 10:00ï¼Œé›»å•†å¹³å°ã€Œå°‹å¯¶ç¶²ã€çš„ç”¢å“è©•å¯©æœƒè­°ã€‚

ç”¢å“ç¸½ç›£ Lisa æ‰“é–‹ç«¶å“ç¶²ç«™æ¼”ç¤ºï¼š

ã€Œä½ å€‘çœ‹ï¼Œåœ¨æ·˜å¯¶è¼¸å…¥ã€iphã€ï¼Œç«‹åˆ»å‡ºç¾ï¼šã€

```
iph
  â†“
ğŸ“± iphone 15 pro max        (2,340,000 æ¬¡æœå°‹)
ğŸ“± iphone å……é›»ç·š            (890,000 æ¬¡æœå°‹)
ğŸ“± iphone æ‰‹æ©Ÿæ®¼            (670,000 æ¬¡æœå°‹)
ğŸ“± iphone 14                (520,000 æ¬¡æœå°‹)
ğŸ“± iphone è€³æ©Ÿ              (380,000 æ¬¡æœå°‹)
```

ã€Œåæ‡‰é€Ÿåº¦ä¸åˆ° 50msï¼Œè€Œä¸”æŒ‰ç†±é–€åº¦æ’åºã€‚ã€

ç„¶å¾Œå¥¹æ‰“é–‹è‡ªå®¶ç¶²ç«™ï¼Œè¼¸å…¥ã€iphã€â€”â€”

**3 ç§’å¾Œæ‰å‡ºç¾çµæœï¼Œè€Œä¸”æ˜¯äº‚åºçš„ã€‚**

```
iph
  â†“ (ç­‰å¾… 3 ç§’...)
ğŸ“± iphone 11
ğŸ“± iphone æ‰‹æ©Ÿæ®¼
ğŸ“± iphone se
ğŸ“± iphone å……é›»å™¨
ğŸ“± iphone xr
```

æœƒè­°å®¤ä¸€ç‰‡æ²‰é»˜ã€‚

æŠ€è¡“ç¸½ç›£ David çœ‹è‘—å¾Œç«¯å·¥ç¨‹å¸« Mikeï¼šã€Œé€™æ˜¯æ€éº¼å›äº‹ï¼Ÿã€

Mike å°·å°¬åœ°è§£é‡‹ï¼šã€Œæˆ‘å€‘ç”¨çš„æ˜¯ SQL LIKE æŸ¥è©¢...ã€

## ç¬¬ä¸€æ¬¡ç½é›£ï¼šLIKE '%keyword%' çš„å™©å¤¢ï¼ˆ2024/05/06ï¼‰

### æœ€åˆçš„å¯¦ç¾ï¼šæš´åŠ› SQL æŸ¥è©¢

Mike ç•¶åˆè¦ºå¾—å¾ˆç°¡å–®ï¼š

```sql
-- å•†å“è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    search_count INT DEFAULT 0,
    created_at TIMESTAMP
);

-- æœå°‹è‡ªå‹•è£œå…¨
SELECT name, search_count
FROM products
WHERE name LIKE '%iph%'
ORDER BY search_count DESC
LIMIT 5;
```

ã€Œåªè¦ç”¨ LIKE æ¨¡ç³ŠæŸ¥è©¢å°±å¥½äº†ï¼ã€Mike è‡ªä¿¡æ»¿æ»¿ã€‚

### ä¸Šç·šç¬¬ä¸€å¤©çš„ç½é›£

**2024/05/07 ä¸Šåˆ 9:00** - è‡ªå‹•è£œå…¨åŠŸèƒ½æ­£å¼ä¸Šç·š

**9:15** - ç”¨æˆ¶é–‹å§‹æŠ•è¨´ã€Œæœå°‹å¾ˆå¡ã€

**9:30** - è³‡æ–™åº« CPU é£†å‡åˆ° 95%

**9:45** - ç¶²ç«™ç™±ç˜“

### å•é¡Œåˆ†æ

DBA Sarah æŸ¥çœ‹æ…¢æŸ¥è©¢æ—¥èªŒï¼š

```sql
-- æ…¢æŸ¥è©¢ #1
SELECT name FROM products
WHERE name LIKE '%iph%'
ORDER BY search_count DESC
LIMIT 5;

åŸ·è¡Œæ™‚é–“ï¼š2,840ms
æƒæè¡Œæ•¸ï¼š12,450,000 è¡Œï¼ˆå…¨è¡¨æƒæï¼ï¼‰
```

**ç½é›£æ•¸æ“šï¼ˆ2024/05/07 09:00-10:00ï¼‰ï¼š**
```
å ´æ™¯ï¼š100 è¬å•†å“ï¼Œæ¯ç§’ 500 å€‹è‡ªå‹•è£œå…¨è«‹æ±‚

å•é¡Œï¼š
- å¹³å‡éŸ¿æ‡‰æ™‚é–“ï¼š2.8 ç§’
- è³‡æ–™åº« CPUï¼š95%ï¼ˆè¢«æŸ¥è©¢æ‹–å®ï¼‰
- æ¯å€‹æŸ¥è©¢æƒæï¼š1,245 è¬è¡Œ
- QPSï¼š500 Ã— 2.8s = 1,400 å€‹ä½µç™¼æŸ¥è©¢ï¼ˆè³‡æ–™åº«å´©æ½°ï¼‰

ç”¨æˆ¶é«”é©—ï¼š
ã€Œè¼¸å…¥ç¬¬ä¸€å€‹å­—æ¯è¦ç­‰ 3 ç§’ï¼Œèª°æœƒç”¨å•Šï¼ã€
```

### ç‚ºä»€éº¼é€™éº¼æ…¢ï¼Ÿ

Sarah è§£é‡‹ï¼š

ã€ŒLIKE '%keyword%' æœ‰å…©å€‹è‡´å‘½å•é¡Œï¼šã€

```
å•é¡Œ 1ï¼šå‰ç¶´é€šé…ç¬¦ç„¡æ³•ä½¿ç”¨ç´¢å¼•
- LIKE 'iph%' â†’ å¯ä»¥ç”¨ B-Tree ç´¢å¼• âœ…
- LIKE '%iph%' â†’ ç„¡æ³•ç”¨ç´¢å¼•ï¼Œå…¨è¡¨æƒæ âŒ

å•é¡Œ 2ï¼šæ¯å€‹è«‹æ±‚éƒ½è¦æƒæå…¨è¡¨
- 100 è¬å•†å“
- æ¯æ¬¡æŸ¥è©¢å¹³å‡æƒæ 50 è¬è¡Œ
- 500 QPS Ã— 50 è¬è¡Œ = 2.5 å„„è¡Œ/ç§’ï¼ˆè³‡æ–™åº«æ‰›ä¸ä½ï¼‰
```

David çšºçœ‰ï¼šã€Œæœ‰æ²’æœ‰è¾¦æ³•åªæŸ¥å‰ç¶´ï¼Ÿæ”¹æˆ `LIKE 'iph%'`ï¼Ÿã€

ã€Œå¯ä»¥ï¼Œä½†ç”¨æˆ¶å¯èƒ½åœ¨ä¸­é–“è¼¸å…¥é—œéµå­—ï¼Œæ¯”å¦‚æœã€å……é›» iphoneã€ï¼Œå°±æ‰¾ä¸åˆ°äº†ã€‚ã€Mike èªªã€‚

## ç¬¬äºŒæ¬¡å˜—è©¦ï¼šå…§å­˜é™£åˆ—ç·šæ€§æƒæï¼ˆ2024/05/08ï¼‰

### æ€è·¯

Mike æƒ³ï¼šã€Œæ—¢ç„¶è³‡æ–™åº«æ…¢ï¼Œé‚£å°±æ”¾å…§å­˜è£¡ï¼ã€

```go
type AutocompleteService struct {
    products []Product  // å…§å­˜é™£åˆ—
}

type Product struct {
    Name        string
    SearchCount int
}

func (s *AutocompleteService) Search(prefix string) []Product {
    results := []Product{}

    // ç·šæ€§æƒæ
    for _, product := range s.products {
        if strings.Contains(product.Name, prefix) {
            results = append(results, product)
        }
    }

    // æ’åºï¼ˆæŒ‰æœå°‹æ¬¡æ•¸ï¼‰
    sort.Slice(results, func(i, j int) bool {
        return results[i].SearchCount > results[j].SearchCount
    })

    // è¿”å›å‰ 5 å€‹
    if len(results) > 5 {
        results = results[:5]
    }

    return results
}
```

ã€Œé€™æ¨£æ‡‰è©²å¿«äº†å§ï¼Ÿå…§å­˜æ“ä½œï¼Œå¾®ç§’ç´šï¼ã€

### ä¸Šç·šæ¸¬è©¦

**2024/05/08 14:00** - æ–°ç‰ˆæœ¬éƒ¨ç½²

åˆæ­¥æ¸¬è©¦ï¼š
```
æ¸¬è©¦ 1ï¼šæŸ¥è©¢ "iph"ï¼ˆåŒ¹é… 1,200 å€‹å•†å“ï¼‰
- æƒææ™‚é–“ï¼š15ms
- æ’åºæ™‚é–“ï¼š8ms
- ç¸½æ™‚é–“ï¼š23ms âœ… çœ‹èµ·ä¾†ä¸éŒ¯ï¼

æ¸¬è©¦ 2ï¼šæŸ¥è©¢ "i"ï¼ˆåŒ¹é… 450,000 å€‹å•†å“ï¼‰
- æƒææ™‚é–“ï¼š680ms
- æ’åºæ™‚é–“ï¼š1,200ms
- ç¸½æ™‚é–“ï¼š1,880ms âŒ é‚„æ˜¯å¾ˆæ…¢ï¼
```

### ç‚ºä»€éº¼é‚„æ˜¯æ…¢ï¼Ÿ

**å•é¡Œ 1ï¼šç·šæ€§æƒæçš„æ™‚é–“è¤‡é›œåº¦**
```
è¤‡é›œåº¦ï¼šO(N)ï¼ŒN = å•†å“ç¸½æ•¸

è¨ˆç®—ï¼š
- 100 è¬å•†å“
- æ¯å€‹å•†å“åç¨±å¹³å‡ 20 å€‹å­—ç¬¦
- strings.Contains() è¤‡é›œåº¦ï¼šO(M)ï¼ŒM = å­—ç¬¦ä¸²é•·åº¦
- ç¸½è¤‡é›œåº¦ï¼šO(N Ã— M) = 100è¬ Ã— 20 = 2,000è¬æ¬¡æ¯”è¼ƒ

çŸ­å‰ç¶´ï¼ˆå¦‚ "i"ï¼‰çš„ç½é›£ï¼š
- åŒ¹é…å•†å“æ•¸ï¼š45 è¬å€‹
- æ’åºè¤‡é›œåº¦ï¼šO(K log K)ï¼ŒK = 45 è¬
- 45è¬ Ã— log(45è¬) â‰ˆ 45è¬ Ã— 19 â‰ˆ 850è¬æ¬¡æ¯”è¼ƒ

çµæœï¼šè¼¸å…¥è¶ŠçŸ­ï¼Œè¶Šæ…¢ï¼
```

**å•é¡Œ 2ï¼šå…§å­˜å ç”¨**
```
è¨ˆç®—ï¼š
- 100 è¬å•†å“
- æ¯å€‹å•†å“åç¨±å¹³å‡ 50 bytes
- ç¸½è¨ˆï¼š100è¬ Ã— 50 bytes = 50 MBï¼ˆé‚„èƒ½æ¥å—ï¼‰

ä½†å¦‚æœåŠ ä¸Šå…¶ä»–æ¬„ä½ï¼ˆæè¿°ã€åˆ†é¡ã€æ¨™ç±¤ï¼‰ï¼š
- 100 è¬ Ã— 500 bytes = 500 MBï¼ˆå–®æ©Ÿå…§å­˜å£“åŠ›ï¼‰
```

Mike æ²®å–ªï¼šã€Œç·šæ€§æƒæä¸è¡Œï¼Œé›£é“è¦éæ­·æ‰€æœ‰å•†å“å—ï¼Ÿã€

## å‡Œæ™¨çš„éˆæ„Ÿï¼šå­—å…¸çš„å•Ÿç™¼ï¼ˆ2024/05/09 å‡Œæ™¨ 2:00ï¼‰

David åœ¨å®¶ç¿»å­—å…¸æŸ¥ã€Œalgorithmã€é€™å€‹è©ã€‚

ä»–æ³¨æ„åˆ°è‡ªå·±çš„æŸ¥æ‰¾éç¨‹ï¼š

```
æ­¥é©Ÿ 1ï¼šç¿»åˆ° A é–‹é ­çš„é é¢ï¼ˆè·³é B-Zï¼‰
æ­¥é©Ÿ 2ï¼šåœ¨ A å€æ‰¾ AL é–‹é ­ï¼ˆè·³é AAã€ABã€AC...ï¼‰
æ­¥é©¤ 3ï¼šåœ¨ AL å€æ‰¾ ALG é–‹é ­
æ­¥é©Ÿ 4ï¼šæ‰¾åˆ° ALGORITHM

é—œéµæ´å¯Ÿï¼š
âŒ ä¸æ˜¯å¾ç¬¬ä¸€é æƒæåˆ°æœ€å¾Œä¸€é ï¼ˆç·šæ€§ï¼‰
âœ… è€Œæ˜¯æŒ‰ã€Œå‰ç¶´ã€é€æ­¥ç¸®å°ç¯„åœï¼ˆæ¨¹ç‹€ï¼‰
```

**ä»–çªç„¶é “æ‚Ÿï¼šé€™ä¸å°±æ˜¯ Trie æ¨¹ï¼ˆå‰ç¶´æ¨¹ï¼‰å—ï¼**

å‡Œæ™¨ 3 é»ï¼ŒDavid åœ¨ç™½æ¿ä¸Šç•«å‡ºï¼š

```
              root
               |
        â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
        i      a      s
        |      |      |
        p      p    â”Œâ”€â”´â”€â”
        |      |    a   u
        h      p    m   n
        |      |    s   g
      â”Œâ”€â”´â”€â”    l   u   l
      o   e    e   n   a
      n   a         g   s
      e   d
        |
   â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
   11   14  15
        |
      â”Œâ”€â”´â”€â”
      p   s
      r   e
      o

      m
      a
      x
```

ã€Œæ¯å€‹ç¯€é»ä»£è¡¨ä¸€å€‹å­—ç¬¦ï¼Œå¾æ ¹åˆ°è‘‰å°±æ˜¯ä¸€å€‹å®Œæ•´çš„è©ï¼ã€

ã€Œæœå°‹ã€iphã€æ™‚ï¼šã€
```
1. å¾ root èµ°åˆ° i ç¯€é»
2. å¾ i èµ°åˆ° p ç¯€é»
3. å¾ p èµ°åˆ° h ç¯€é»
4. æ”¶é›† h ç¯€é»ä¸‹çš„æ‰€æœ‰å®Œæ•´è©

æ™‚é–“è¤‡é›œåº¦ï¼šO(M)ï¼ŒM = å‰ç¶´é•·åº¦
è€Œä¸æ˜¯ O(N)ï¼ŒN = å•†å“ç¸½æ•¸ï¼
```

## æ”¹é€²æ–¹æ¡ˆï¼šTrie æ¨¹ï¼ˆå‰ç¶´æ¨¹ï¼‰

### æ•¸æ“šçµæ§‹

```go
type TrieNode struct {
    Children    map[rune]*TrieNode  // å­ç¯€é»
    IsEnd       bool                 // æ˜¯å¦ç‚ºè©çš„çµå°¾
    Word        string               // å®Œæ•´çš„è©ï¼ˆåƒ…è‘‰ç¯€é»ï¼‰
    SearchCount int                  // æœå°‹æ¬¡æ•¸ï¼ˆç†±åº¦ï¼‰
}

type Trie struct {
    Root *TrieNode
    mu   sync.RWMutex
}

func NewTrie() *Trie {
    return &Trie{
        Root: &TrieNode{
            Children: make(map[rune]*TrieNode),
        },
    }
}
```

### æ’å…¥æ“ä½œ

```go
func (t *Trie) Insert(word string, searchCount int) {
    t.mu.Lock()
    defer t.mu.Unlock()

    node := t.Root

    // é€å­—ç¬¦å»ºç«‹è·¯å¾‘
    for _, char := range word {
        if node.Children[char] == nil {
            node.Children[char] = &TrieNode{
                Children: make(map[rune]*TrieNode),
            }
        }
        node = node.Children[char]
    }

    // æ¨™è¨˜è©çš„çµå°¾
    node.IsEnd = true
    node.Word = word
    node.SearchCount = searchCount
}
```

**ç¯„ä¾‹ï¼šæ’å…¥ "iphone 15 pro max"**

```
æ’å…¥éç¨‹ï¼š
root â†’ i â†’ p â†’ h â†’ o â†’ n â†’ e â†’ ' ' â†’ 1 â†’ 5 â†’ ' ' â†’ p â†’ r â†’ o â†’ ' ' â†’ m â†’ a â†’ x
                                                                              â†‘
                                                                         IsEnd=true
                                                                    Word="iphone 15 pro max"
                                                                    SearchCount=2,340,000
```

### æœå°‹æ“ä½œ

```go
func (t *Trie) Search(prefix string) []string {
    t.mu.RLock()
    defer t.mu.RUnlock()

    // 1. æ‰¾åˆ°å‰ç¶´å°æ‡‰çš„ç¯€é»
    node := t.Root
    for _, char := range prefix {
        if node.Children[char] == nil {
            return []string{}  // å‰ç¶´ä¸å­˜åœ¨
        }
        node = node.Children[char]
    }

    // 2. å¾è©²ç¯€é»é–‹å§‹ï¼Œæ”¶é›†æ‰€æœ‰å®Œæ•´çš„è©
    results := []string{}
    t.collectWords(node, &results)

    return results
}

func (t *Trie) collectWords(node *TrieNode, results *[]string) {
    if node.IsEnd {
        *results = append(*results, node.Word)
    }

    for _, child := range node.Children {
        t.collectWords(child, results)
    }
}
```

**ç¯„ä¾‹ï¼šæœå°‹ "iph"**

```
æ­¥é©Ÿ 1ï¼šå®šä½åˆ° 'h' ç¯€é»
root â†’ i â†’ p â†’ h
              â†“
        æ‰¾åˆ°é€™å€‹ç¯€é»

æ­¥é©Ÿ 2ï¼šå¾ 'h' ç¯€é»é–‹å§‹ï¼Œéæ­·æ‰€æœ‰å­æ¨¹
h
â”œâ”€â”€ o â†’ n â†’ e â†’ ' ' â†’ 1 â†’ 1 (iphone 11)
â”‚                  â””â”€â†’ 4 (iphone 14)
â”‚                  â””â”€â†’ 5 â†’ ' ' â†’ p â†’ r â†’ o â†’ ... (iphone 15 pro max)
â”‚
â””â”€â”€ e â†’ a â†’ d â†’ p â†’ h â†’ o â†’ n â†’ e â†’ s (ipheadphones) âŒ ä¸å­˜åœ¨

çµæœï¼š["iphone 11", "iphone 14", "iphone 15", "iphone 15 pro max", ...]
```

### æ€§èƒ½å°æ¯”ï¼ˆ2024/05/10 æ¸¬è©¦ï¼‰

```
æ¸¬è©¦ç’°å¢ƒï¼š100 è¬å•†å“

æ–¹æ¡ˆ Aï¼šSQL LIKE '%iph%'
- æŸ¥è©¢æ™‚é–“ï¼š2,840ms
- è¤‡é›œåº¦ï¼šO(N)ï¼Œå…¨è¡¨æƒæ

æ–¹æ¡ˆ Bï¼šå…§å­˜é™£åˆ—ç·šæ€§æƒæ
- æŸ¥è©¢æ™‚é–“ï¼š680msï¼ˆçŸ­å‰ç¶´ "i"ï¼‰
- è¤‡é›œåº¦ï¼šO(N)

æ–¹æ¡ˆ Cï¼šTrie æ¨¹
- æŸ¥è©¢æ™‚é–“ï¼š3ms âœ…
- è¤‡é›œåº¦ï¼šO(M + K)
  - M = å‰ç¶´é•·åº¦ï¼ˆ"iph" = 3ï¼‰
  - K = åŒ¹é…çµæœæ•¸é‡ï¼ˆå‡è¨­ 1,200 å€‹ï¼‰
  - 3 + 1,200 = 1,203 æ¬¡æ“ä½œï¼ˆvs 100 è¬æ¬¡ï¼‰

æå‡ï¼š
- ç›¸æ¯” SQLï¼š2,840ms â†’ 3msï¼ˆæå‡ 946 å€ï¼‰
- ç›¸æ¯”ç·šæ€§æƒæï¼š680ms â†’ 3msï¼ˆæå‡ 226 å€ï¼‰
```

Mike èˆˆå¥®åœ°èªªï¼šã€Œå¤ªå¿«äº†ï¼ä½†é‚„æœ‰å€‹å•é¡Œ...ã€

## ç¬¬ä¸‰æ¬¡ç½é›£ï¼šçµæœå¤ªå¤šäº†ï¼ˆ2024/05/12ï¼‰

### å•é¡Œï¼šåŒ¹é…çµæœçˆ†ç‚¸

ç”¢å“ç¶“ç† Lisa æ¸¬è©¦å¾Œç™¼ç¾ï¼š

```
æœå°‹ "i"ï¼š
è¿”å›çµæœï¼š450,000 å€‹å•†å“
ç”¨æˆ¶åªèƒ½çœ‹å‰ 5 å€‹ï¼Œä½†æˆ‘å€‘è¿”å›äº† 45 è¬å€‹ï¼

å•é¡Œï¼š
1. å…§å­˜å ç”¨ï¼š45 è¬å€‹å­—ç¬¦ä¸² = 20 MB
2. ç¶²çµ¡å‚³è¼¸ï¼š20 MB çš„ JSONï¼ˆç”¨æˆ¶æ ¹æœ¬ä¸éœ€è¦ï¼‰
3. å‰ç«¯æ¸²æŸ“ï¼šç€è¦½å™¨å¡æ­»

è€Œä¸”çµæœæ˜¯äº‚åºçš„ï¼š
[
    "iphone se",           (38,000 æ¬¡æœå°‹)
    "ipad mini",           (520,000 æ¬¡æœå°‹) â† æ‡‰è©²æ’ç¬¬ä¸€
    "iphone 11",           (180,000 æ¬¡æœå°‹)
    "iwatch",              (92,000 æ¬¡æœå°‹)
    ...
]
```

**ç”¨æˆ¶éœ€è¦çš„æ˜¯ï¼šæŒ‰ç†±åº¦æ’åºçš„å‰ 5 å€‹çµæœï¼**

### ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šæ”¶é›†æ‰€æœ‰çµæœå†æ’åº

```go
func (t *Trie) SearchTopK(prefix string, k int) []string {
    // 1. æ”¶é›†æ‰€æœ‰åŒ¹é…çµæœ
    allResults := t.Search(prefix)  // å¯èƒ½æœ‰ 45 è¬å€‹

    // 2. æŒ‰æœå°‹æ¬¡æ•¸æ’åº
    sort.Slice(allResults, func(i, j int) bool {
        return allResults[i].SearchCount > allResults[j].SearchCount
    })

    // 3. è¿”å›å‰ K å€‹
    if len(allResults) > k {
        return allResults[:k]
    }
    return allResults
}
```

**å•é¡Œï¼š**
```
æœå°‹ "i"ï¼Œè¿”å›å‰ 5 å€‹ï¼š
- æ”¶é›† 45 è¬å€‹çµæœï¼š200ms
- æ’åº 45 è¬å€‹ï¼š1,100ms
- æˆªå–å‰ 5 å€‹ï¼š0.1ms
- ç¸½è¨ˆï¼š1,300ms

ç”¨æˆ¶åªè¦ 5 å€‹çµæœï¼Œæˆ‘å€‘å»æ’åºäº† 45 è¬å€‹ï¼
```

### éˆæ„Ÿï¼šæœ€å°å †ï¼ˆMin Heapï¼‰

David æé†’ï¼šã€Œé€™ä¸å°±æ˜¯ç¶“å…¸çš„ Top K å•é¡Œå—ï¼Ÿã€

**æ ¸å¿ƒæ€æƒ³ï¼š**
```
ç”¨ä¸€å€‹å¤§å°ç‚º K çš„æœ€å°å †ï¼ˆMin Heapï¼‰ï¼š
- å †é ‚æ˜¯ç•¶å‰ K å€‹æœ€å¤§å€¼ä¸­çš„æœ€å°å€¼
- éæ­·æ™‚ï¼Œå¦‚æœæ–°å…ƒç´  > å †é ‚ï¼Œæ›¿æ›å †é ‚
- éæ­·çµæŸå¾Œï¼Œå †ä¸­å°±æ˜¯ Top K

è¤‡é›œåº¦ï¼š
- ç¶­è­·å †ï¼šO(log K)
- éæ­· N å€‹å…ƒç´ ï¼šO(N log K)
- ç›¸æ¯”å…¨æ’åº O(N log N)ï¼Œç•¶ K << N æ™‚ï¼Œå¤§å¹…å„ªåŒ–ï¼

ç¯„ä¾‹ï¼ˆK=5ï¼‰ï¼š
ç•¶å‰å †ï¼š[50K, 80K, 120K, 200K, 300K]ï¼ˆå †é ‚ 50Kï¼‰
æ–°å…ƒç´ ï¼š60K > 50K â†’ æ›¿æ›å †é ‚
æ–°å †ï¼š  [60K, 80K, 120K, 200K, 300K]
```

### æ”¹é€²å¯¦ç¾ï¼šTrie + æœ€å°å †

```go
type Product struct {
    Word        string
    SearchCount int
}

// æœ€å°å †ï¼ˆåŸºæ–¼ container/heapï¼‰
type MinHeap []Product

func (h MinHeap) Len() int           { return len(h) }
func (h MinHeap) Less(i, j int) bool { return h[i].SearchCount < h[j].SearchCount }
func (h MinHeap) Swap(i, j int)      { h[i], h[j] = h[j], h[i] }

func (h *MinHeap) Push(x interface{}) {
    *h = append(*h, x.(Product))
}

func (h *MinHeap) Pop() interface{} {
    old := *h
    n := len(old)
    x := old[n-1]
    *h = old[0 : n-1]
    return x
}

func (t *Trie) SearchTopK(prefix string, k int) []Product {
    t.mu.RLock()
    defer t.mu.RUnlock()

    // 1. å®šä½åˆ°å‰ç¶´ç¯€é»
    node := t.Root
    for _, char := range prefix {
        if node.Children[char] == nil {
            return []Product{}
        }
        node = node.Children[char]
    }

    // 2. ç”¨æœ€å°å †æ”¶é›† Top K
    h := &MinHeap{}
    heap.Init(h)

    t.collectTopK(node, h, k)

    // 3. å¾å †ä¸­å–å‡ºçµæœï¼ˆå·²æ’åºï¼‰
    results := make([]Product, h.Len())
    for i := h.Len() - 1; i >= 0; i-- {
        results[i] = heap.Pop(h).(Product)
    }

    return results
}

func (t *Trie) collectTopK(node *TrieNode, h *MinHeap, k int) {
    if node.IsEnd {
        product := Product{
            Word:        node.Word,
            SearchCount: node.SearchCount,
        }

        if h.Len() < k {
            // å †æœªæ»¿ï¼Œç›´æ¥æ’å…¥
            heap.Push(h, product)
        } else if product.SearchCount > (*h)[0].SearchCount {
            // æ–°å…ƒç´ æ¯”å †é ‚å¤§ï¼Œæ›¿æ›å †é ‚
            heap.Pop(h)
            heap.Push(h, product)
        }
    }

    for _, child := range node.Children {
        t.collectTopK(child, h, k)
    }
}
```

### æ€§èƒ½å°æ¯”ï¼ˆ2024/05/13 æ¸¬è©¦ï¼‰

```
æœå°‹ "i"ï¼Œè¿”å›å‰ 5 å€‹ï¼š

æ–¹æ¡ˆ Aï¼šæ”¶é›†æ‰€æœ‰ + å…¨æ’åº
- æ”¶é›†ï¼š200ms
- æ’åº 45 è¬å€‹ï¼š1,100ms
- ç¸½è¨ˆï¼š1,300ms

æ–¹æ¡ˆ Bï¼šTrie + æœ€å°å †ï¼ˆK=5ï¼‰
- éæ­· 45 è¬å€‹ç¯€é»ï¼š180ms
- å †æ“ä½œï¼ˆæ¯æ¬¡ O(log 5) â‰ˆ 2.3ï¼‰ï¼š
  45è¬ Ã— 2.3 Ã— 0.0001ms â‰ˆ 103ms
- ç¸½è¨ˆï¼š283ms

æå‡ï¼š1,300ms â†’ 283msï¼ˆæå‡ 4.6 å€ï¼‰

æ›´é‡è¦çš„æ˜¯ï¼š
- å…§å­˜å ç”¨ï¼š20 MB â†’ å¹¾ KBï¼ˆåªç¶­è­· 5 å€‹å…ƒç´ çš„å †ï¼‰
- ç¶²çµ¡å‚³è¼¸ï¼š20 MB â†’ 500 bytes
```

## ç¬¬å››æ¬¡ç½é›£ï¼šå…§å­˜çˆ†ç‚¸ï¼ˆ2024/05/20ï¼‰

### èƒŒæ™¯ï¼šå•†å“æ•¸é‡å¢é•·

ä¸€å€‹æœˆå¾Œï¼Œé‹ç‡Ÿåœ˜éšŠèˆˆå¥®åœ°å®£å¸ƒï¼š

ã€Œæˆ‘å€‘æ–°å¢äº† 500 è¬å€‹å•†å“ï¼ç¾åœ¨ç¸½å…± 600 è¬å€‹ SKUï¼ã€

å‡Œæ™¨ 3 é»ï¼Œç›£æ§å‘Šè­¦ï¼š

```
æœå‹™å™¨å…§å­˜ä½¿ç”¨ï¼š
2024-05-20 03:00 - 8 GB
2024-05-20 03:15 - 12 GB
2024-05-20 03:30 - 16 GBï¼ˆè§¸ç™¼å‘Šè­¦ï¼‰
2024-05-20 03:45 - OOM Killedï¼ˆæœå‹™å´©æ½°ï¼‰
```

### å•é¡Œåˆ†æ

Mike è¨ˆç®—å…§å­˜å ç”¨ï¼š

```
Trie æ¨¹å…§å­˜è¨ˆç®—ï¼š

å‡è¨­ï¼š
- 600 è¬å•†å“
- å¹³å‡æ¯å€‹å•†å“åç¨± 30 å€‹å­—ç¬¦
- å­—ç¬¦é›†ï¼šè‹±æ–‡ + æ•¸å­— + ç©ºæ ¼ + ä¸­æ–‡ï¼ˆç´„ 10,000 å€‹å¸¸ç”¨å­—ï¼‰

æœ€å£æƒ…æ³ï¼ˆç„¡å…±äº«å‰ç¶´ï¼‰ï¼š
- ç¯€é»æ•¸ï¼š600è¬ Ã— 30 = 1.8 å„„å€‹ç¯€é»
- æ¯å€‹ç¯€é»ï¼š
  - Children mapï¼š8 bytesï¼ˆæŒ‡é‡ï¼‰Ã— å¹³å‡ 2 å€‹å­ç¯€é» = 16 bytes
  - IsEndï¼š1 byte
  - Wordï¼š8 bytesï¼ˆæŒ‡é‡ï¼‰+ å¹³å‡ 30 bytesï¼ˆå­—ç¬¦ä¸²ï¼‰
  - SearchCountï¼š8 bytes
  - ç¸½è¨ˆï¼šç´„ 63 bytes/ç¯€é»
- ç¸½å…§å­˜ï¼š1.8 å„„ Ã— 63 bytes â‰ˆ 11 GB âŒ

å¯¦éš›æƒ…æ³ï¼ˆæœ‰å…±äº«å‰ç¶´ï¼‰ï¼š
- "iphone 11", "iphone 12", "iphone 13" å…±äº« "iphone "
- å£“ç¸®ç‡ç´„ 30%
- å¯¦éš›å…§å­˜ï¼š11 GB Ã— 0.7 â‰ˆ 7.7 GB

å•é¡Œï¼š
- å–®æ©Ÿå…§å­˜å£“åŠ›å¤§
- é‡å•Ÿæ™‚éœ€è¦é‡å»º Trieï¼ˆè€—æ™‚ 5 åˆ†é˜ï¼‰
- ç„¡æ³•æ©«å‘æ“´å±•ï¼ˆTrie æ˜¯å…§å­˜çµæ§‹ï¼‰
```

### å„ªåŒ– 1ï¼šå£“ç¸® Trieï¼ˆCompressed Trie / Radix Treeï¼‰

**æ ¸å¿ƒæ€æƒ³ï¼šåˆä½µåªæœ‰ä¸€å€‹å­ç¯€é»çš„è·¯å¾‘**

```
åŸå§‹ Trieï¼š
root â†’ i â†’ p â†’ h â†’ o â†’ n â†’ e â†’ ç©ºæ ¼ â†’ 1 â†’ 1 (9 å€‹ç¯€é»)

å£“ç¸® Trieï¼ˆRadix Treeï¼‰ï¼š
root â†’ "iphone " â†’ "11" (2 å€‹ç¯€é»)
                â†’ "12"
                â†’ "13"
                â†’ "14"
                â†’ "15"
```

**å¯¦ç¾ï¼š**

```go
type RadixNode struct {
    Prefix      string                // å£“ç¸®çš„å­—ç¬¦ä¸²ç‰‡æ®µ
    Children    map[rune]*RadixNode   // åªå­˜å„²é¦–å­—ç¬¦
    IsEnd       bool
    Word        string
    SearchCount int
}

func (r *RadixTree) Insert(word string, count int) {
    node := r.Root
    remaining := word

    for len(remaining) > 0 {
        char := rune(remaining[0])

        if child := node.Children[char]; child != nil {
            // æ‰¾åˆ°å…¬å…±å‰ç¶´
            commonLen := commonPrefixLen(child.Prefix, remaining)

            if commonLen == len(child.Prefix) {
                // å®Œå…¨åŒ¹é…ï¼Œç¹¼çºŒå¾€ä¸‹
                node = child
                remaining = remaining[commonLen:]
            } else {
                // éƒ¨åˆ†åŒ¹é…ï¼Œéœ€è¦åˆ†è£‚ç¯€é»
                r.splitNode(child, commonLen)
                remaining = remaining[commonLen:]
            }
        } else {
            // å‰µå»ºæ–°ç¯€é»
            newNode := &RadixNode{
                Prefix:   remaining,
                Children: make(map[rune]*RadixNode),
                IsEnd:    true,
                Word:     word,
                SearchCount: count,
            }
            node.Children[char] = newNode
            return
        }
    }

    node.IsEnd = true
    node.Word = word
    node.SearchCount = count
}
```

**å…§å­˜å°æ¯”ï¼š**

```
åŸå§‹ Trieï¼š
- "iphone 11"ï¼š9 å€‹ç¯€é»
- "iphone 12"ï¼š9 å€‹ç¯€é»
- "iphone 13"ï¼š9 å€‹ç¯€é»
- ç¸½è¨ˆï¼š27 å€‹ç¯€é»ï¼ˆæœ‰é‡è¤‡ï¼‰
- å¯¦éš›ï¼š9 å€‹ç¯€é»ï¼ˆå…±äº« "iphone "ï¼‰

å£“ç¸® Trieï¼ˆRadix Treeï¼‰ï¼š
- root â†’ "iphone "ï¼š1 å€‹ç¯€é»
  - â†’ "11"ï¼š1 å€‹ç¯€é»
  - â†’ "12"ï¼š1 å€‹ç¯€é»
  - â†’ "13"ï¼š1 å€‹ç¯€é»
- ç¸½è¨ˆï¼š4 å€‹ç¯€é»

ç¯€çœï¼š9 â†’ 4ï¼ˆç¯€çœ 55%ï¼‰

600 è¬å•†å“ï¼š
- åŸå§‹ Trieï¼š7.7 GB
- Radix Treeï¼š3.5 GBï¼ˆç¯€çœ 54%ï¼‰
```

### å„ªåŒ– 2ï¼šæ‡¶åŠ è¼‰ + æŒä¹…åŒ–

**å•é¡Œï¼š** é‡å•Ÿæ™‚éœ€è¦é‡å»º Trieï¼ˆ5 åˆ†é˜ï¼‰

**æ–¹æ¡ˆï¼š** å®šæœŸå¿«ç…§ + å¢é‡æ›´æ–°

```go
type TrieStore struct {
    trie      *Trie
    cache     *redis.Client
    db        *sql.DB
    dirty     bool
    lastSave  time.Time
}

// å®šæœŸä¿å­˜å¿«ç…§
func (s *TrieStore) StartAutoSave() {
    ticker := time.NewTicker(5 * time.Minute)
    for range ticker.C {
        if s.dirty {
            s.saveSnapshot()
            s.dirty = false
        }
    }
}

func (s *TrieStore) saveSnapshot() {
    // åºåˆ—åŒ– Trie åˆ°æ–‡ä»¶
    data, _ := s.trie.Marshal()  // ä½¿ç”¨ gob æˆ– protobuf
    os.WriteFile("/data/trie-snapshot.bin", data, 0644)

    log.Printf("Trie snapshot saved (size: %d MB)", len(data)/1024/1024)
}

// å•Ÿå‹•æ™‚åŠ è¼‰å¿«ç…§
func (s *TrieStore) LoadSnapshot() error {
    data, err := os.ReadFile("/data/trie-snapshot.bin")
    if err != nil {
        return err
    }

    s.trie = &Trie{}
    s.trie.Unmarshal(data)

    // åŠ è¼‰å¢é‡æ›´æ–°ï¼ˆå¿«ç…§ä¹‹å¾Œçš„æ–°å•†å“ï¼‰
    s.loadIncrementalUpdates()

    return nil
}
```

**æ•ˆæœï¼š**
```
é‡å•Ÿå‰ï¼š
- é‡å»º Trieï¼šå¾è³‡æ–™åº«è®€å– 600 è¬å•†å“
- è€—æ™‚ï¼š5 åˆ†é˜
- æœå‹™ä¸å¯ç”¨ï¼š5 åˆ†é˜

é‡å•Ÿå¾Œï¼ˆå¿«ç…§ï¼‰ï¼š
- åŠ è¼‰å¿«ç…§ï¼šè®€å– 3.5 GB æ–‡ä»¶
- è€—æ™‚ï¼š15 ç§’
- å¢é‡æ›´æ–°ï¼šè®€å–æœ€è¿‘æ–°å¢çš„ 1,000 å€‹å•†å“
- è€—æ™‚ï¼š0.5 ç§’
- ç¸½è¨ˆï¼š15.5 ç§’ âœ…
```

## ç¬¬äº”æ¬¡æŒ‘æˆ°ï¼šæ‹¼å¯«ç³¾æ­£ï¼ˆ2024/06/01ï¼‰

### ç”¨æˆ¶éœ€æ±‚

Lisaï¼šã€Œç”¨æˆ¶è¼¸å…¥ `ipone`ï¼ˆæ‹¼éŒ¯äº†ï¼‰ï¼Œæ‡‰è©²æç¤º `iphone`ï¼Œåƒ Google é‚£æ¨£ã€‚ã€

```
ç”¨æˆ¶è¼¸å…¥ï¼šipone
        â†“
ç³»çµ±æç¤ºï¼šæ‚¨æ˜¯ä¸æ˜¯è¦æ‰¾ï¼šiphone
```

### å•é¡Œï¼šå¦‚ä½•æ‰¾åˆ°ã€Œç›¸ä¼¼ã€çš„è©ï¼Ÿ

**æ–¹æ¡ˆå°æ¯”ï¼š**

#### æ–¹æ¡ˆ Aï¼šç·¨è¼¯è·é›¢ï¼ˆLevenshtein Distanceï¼‰

```
å®šç¾©ï¼šå°‡å­—ç¬¦ä¸² A è®Šæˆ B éœ€è¦çš„æœ€å°‘æ“ä½œæ¬¡æ•¸

æ“ä½œé¡å‹ï¼š
1. æ’å…¥ä¸€å€‹å­—ç¬¦
2. åˆªé™¤ä¸€å€‹å­—ç¬¦
3. æ›¿æ›ä¸€å€‹å­—ç¬¦

ç¯„ä¾‹ï¼š
"ipone" â†’ "iphone"
- åœ¨ä½ç½® 2 æ’å…¥ 'h'ï¼š1 æ¬¡æ“ä½œ
- ç·¨è¼¯è·é›¢ = 1

"iphon" â†’ "iphone"
- åœ¨æœ«å°¾æ’å…¥ 'e'ï¼š1 æ¬¡æ“ä½œ
- ç·¨è¼¯è·é›¢ = 1

"ipone" â†’ "samsung"
- éœ€è¦å¤šæ¬¡æ“ä½œï¼šç·¨è¼¯è·é›¢ = 7
```

**å¯¦ç¾ï¼šå‹•æ…‹è¦åŠƒ**

```go
func levenshteinDistance(s1, s2 string) int {
    m, n := len(s1), len(s2)
    dp := make([][]int, m+1)
    for i := range dp {
        dp[i] = make([]int, n+1)
    }

    // åˆå§‹åŒ–
    for i := 0; i <= m; i++ {
        dp[i][0] = i
    }
    for j := 0; j <= n; j++ {
        dp[0][j] = j
    }

    // å‹•æ…‹è¦åŠƒ
    for i := 1; i <= m; i++ {
        for j := 1; j <= n; j++ {
            if s1[i-1] == s2[j-1] {
                dp[i][j] = dp[i-1][j-1]
            } else {
                dp[i][j] = min(
                    dp[i-1][j]+1,   // åˆªé™¤
                    dp[i][j-1]+1,   // æ’å…¥
                    dp[i-1][j-1]+1, // æ›¿æ›
                )
            }
        }
    }

    return dp[m][n]
}

func (t *Trie) FuzzySearch(query string, maxDistance int) []string {
    results := []string{}

    // éæ­·æ‰€æœ‰è©ï¼Œè¨ˆç®—ç·¨è¼¯è·é›¢
    for _, word := range t.GetAllWords() {
        if levenshteinDistance(query, word) <= maxDistance {
            results = append(results, word)
        }
    }

    return results
}
```

**å•é¡Œï¼šå¤ªæ…¢ï¼**

```
è¨ˆç®—ï¼š
- 600 è¬å€‹è©
- æ¯å€‹è©è¨ˆç®—ç·¨è¼¯è·é›¢ï¼šO(M Ã— N)ï¼ŒM, N = è©é•·åº¦
- å‡è¨­å¹³å‡è©é•· 20
- å–®æ¬¡æŸ¥è©¢ï¼š600è¬ Ã— 20 Ã— 20 = 2.4 å„„æ¬¡æ“ä½œ
- è€—æ™‚ï¼šç´„ 5 ç§’ âŒ
```

#### æ–¹æ¡ˆ Bï¼šBK-Treeï¼ˆBurkhard-Keller Treeï¼‰

**æ ¸å¿ƒæ€æƒ³ï¼š** ç”¨æ¨¹çµæ§‹çµ„ç¹”è©ï¼ŒæŒ‰ç·¨è¼¯è·é›¢åˆ†çµ„

```
æ§‹å»ºï¼š
1. é¸æ“‡ä¸€å€‹è©ä½œç‚ºæ ¹ï¼ˆå¦‚ "book"ï¼‰
2. å°æ–¼æ¯å€‹æ–°è©ï¼Œè¨ˆç®—èˆ‡æ ¹çš„ç·¨è¼¯è·é›¢ d
3. åœ¨è·é›¢ d çš„å­æ¨¹ä¸­éæ­¸æ’å…¥

ç¯„ä¾‹ï¼š
              book (root)
               |
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    d=1       d=2       d=3
     |         |         |
   cook      boot      look
              |
           â”Œâ”€â”€â”´â”€â”€â”
          d=1   d=2
           |     |
         boat  root

æŸ¥è©¢ "bok"ï¼ˆmaxDistance=1ï¼‰ï¼š
1. è¨ˆç®—èˆ‡ root çš„è·é›¢ï¼šd("bok", "book") = 1
2. åªéœ€æœç´¢ d-1 åˆ° d+1 çš„å­æ¨¹ï¼ˆå³ 0, 1, 2ï¼‰
3. å‰ªæï¼šè·³é d=3 çš„å­æ¨¹

è¤‡é›œåº¦ï¼šO(log N)ï¼ˆå¹³å‡æƒ…æ³ï¼‰
```

#### æ–¹æ¡ˆ Cï¼šå…ˆ Trie æœå°‹ï¼Œæ‰¾ä¸åˆ°å†æ¨¡ç³ŠåŒ¹é…

**æŠ˜è¡·æ–¹æ¡ˆï¼š**

```go
func (s *AutocompleteService) Search(query string) []Product {
    // 1. å…ˆå˜—è©¦ç²¾ç¢ºåŒ¹é…ï¼ˆTrieï¼‰
    results := s.trie.SearchTopK(query, 5)
    if len(results) > 0 {
        return results
    }

    // 2. æ‰¾ä¸åˆ°ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…ï¼ˆç·¨è¼¯è·é›¢ <= 2ï¼‰
    // å„ªåŒ–ï¼šåªåœ¨å‰ 1,000 å€‹é«˜é »è©ä¸­æœå°‹
    fuzzyResults := s.fuzzySearchTopWords(query, 2)
    return fuzzyResults
}

func (s *AutocompleteService) fuzzySearchTopWords(query string, maxDist int) []Product {
    results := []Product{}

    // åªåœ¨ Top 1,000 ç†±é–€è©ä¸­æ¨¡ç³ŠåŒ¹é…
    for _, word := range s.topWords[:1000] {
        if levenshteinDistance(query, word.Name) <= maxDist {
            results = append(results, word)
        }
    }

    sort.Slice(results, func(i, j int) bool {
        return results[i].SearchCount > results[j].SearchCount
    })

    if len(results) > 5 {
        return results[:5]
    }
    return results
}
```

**æ€§èƒ½ï¼š**
```
ç²¾ç¢ºåŒ¹é…ï¼ˆ90% æƒ…æ³ï¼‰ï¼š
- Trie æœå°‹ï¼š3ms âœ…

æ¨¡ç³ŠåŒ¹é…ï¼ˆ10% æƒ…æ³ï¼‰ï¼š
- åªæœå°‹ Top 1,000 è©
- 1,000 Ã— ç·¨è¼¯è·é›¢è¨ˆç®—ï¼š50ms
- ä»å¯æ¥å— âœ…
```

## æ–°çš„æŒ‘æˆ°ï¼šæ“´å±•æ€§ï¼ˆåƒè¬ç´šå•†å“ï¼‰

### å–®æ©Ÿç“¶é ¸

```
ç•¶å‰æ¶æ§‹ï¼ˆå–®æ©Ÿ Trieï¼‰ï¼š
- æ”¯æŒå•†å“æ•¸ï¼šç´„ 1,000 è¬ï¼ˆå…§å­˜ 12 GBï¼‰
- QPSï¼šç´„ 5,000ï¼ˆå–®æ©Ÿ CPUï¼‰

å•é¡Œï¼š
- ç„¡æ³•æ©«å‘æ“´å±•ï¼ˆå…§å­˜çµæ§‹ï¼‰
- å–®é»æ•…éšœ
- æ›´æ–°å›°é›£ï¼ˆæ–°å¢å•†å“éœ€è¦é‡å»ºï¼‰
```

### 10x æ“´å±•ï¼šRedis + åˆ†ç‰‡

```
æ¶æ§‹è®ŠåŒ–ï¼š

ç•¶å‰ï¼ˆå–®æ©Ÿ Trieï¼‰ï¼š
Client â†’ Autocomplete Service (å…§å­˜ Trie)

å„ªåŒ–å¾Œï¼ˆRedis åˆ†ç‰‡ï¼‰ï¼š
Client â†’ Load Balancer
         â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    LB1      LB2      LB3      LB4
    â†“        â†“        â†“        â†“
  Redis    Redis    Redis    Redis
  (a-f)    (g-l)    (m-r)    (s-z)

åˆ†ç‰‡ç­–ç•¥ï¼š
- æŒ‰é¦–å­—æ¯åˆ†ç‰‡ï¼ˆ26 å€‹åˆ†ç‰‡ï¼‰
- "iphone" â†’ è·¯ç”±åˆ° Redis Shard (i)
- "samsung" â†’ è·¯ç”±åˆ° Redis Shard (s)

Redis æ•¸æ“šçµæ§‹ï¼š
ZADD autocomplete:i 2340000 "iphone 15 pro max"
ZADD autocomplete:i 890000 "iphone å……é›»ç·š"
ZADD autocomplete:i 670000 "iphone æ‰‹æ©Ÿæ®¼"

æŸ¥è©¢ï¼š
> ZREVRANGEBYSCORE autocomplete:i +inf -inf LIMIT 0 5
1) "iphone 15 pro max"
2) "iphone å……é›»ç·š"
3) "iphone æ‰‹æ©Ÿæ®¼"

è¤‡é›œåº¦ï¼šO(log N + K)
```

**å•é¡Œï¼š** å‰ç¶´åŒ¹é…å›°é›£

```
Redis Sorted Set ç„¡æ³•ç›´æ¥æ”¯æŒå‰ç¶´æŸ¥è©¢ï¼š
- ZREVRANGEBYSCORE åªèƒ½æŒ‰åˆ†æ•¸ç¯„åœæŸ¥è©¢
- ç„¡æ³•æŸ¥è©¢ã€Œä»¥ 'iph' é–‹é ­çš„æ‰€æœ‰ keyã€

è§£æ±ºæ–¹æ¡ˆ 1ï¼šé ç”Ÿæˆæ‰€æœ‰å‰ç¶´
ZADD autocomplete:i 2340000 "iphone 15 pro max"
ZADD autocomplete:ip 2340000 "iphone 15 pro max"
ZADD autocomplete:iph 2340000 "iphone 15 pro max"
ZADD autocomplete:ipho 2340000 "iphone 15 pro max"
...

å•é¡Œï¼šå­˜å„²çˆ†ç‚¸
- æ¯å€‹è©å¹³å‡ 20 å€‹å­—ç¬¦ â†’ 20 å€‹å‰ç¶´
- 1,000 è¬è© Ã— 20 = 2 å„„å€‹ key âŒ

è§£æ±ºæ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Redis Modules
- RediSearchï¼šæ”¯æŒå…¨æ–‡æª¢ç´¢å’Œå‰ç¶´åŒ¹é…
- RedisJSON + RediSearchï¼šé«˜æ•ˆç´¢å¼•
```

### 100x æ“´å±•ï¼šElasticsearch

```
æ¶æ§‹ï¼š
Client â†’ API Gateway
         â†“
    Autocomplete Service
         â†“
    Elasticsearch Cluster
    (3 master + 10 data nodes)

Elasticsearch ç´¢å¼•è¨­è¨ˆï¼š
{
  "settings": {
    "analysis": {
      "analyzer": {
        "autocomplete": {
          "tokenizer": "autocomplete_tokenizer",
          "filter": ["lowercase"]
        }
      },
      "tokenizer": {
        "autocomplete_tokenizer": {
          "type": "edge_ngram",
          "min_gram": 1,
          "max_gram": 20,
          "token_chars": ["letter", "digit"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "name": {
        "type": "text",
        "analyzer": "autocomplete",
        "search_analyzer": "standard"
      },
      "search_count": {
        "type": "long"
      }
    }
  }
}

æŸ¥è©¢ï¼š
POST /products/_search
{
  "query": {
    "match": {
      "name": {
        "query": "iph",
        "operator": "and"
      }
    }
  },
  "sort": [
    { "search_count": "desc" }
  ],
  "size": 5
}

å„ªå‹¢ï¼š
- æ”¯æŒ 1 å„„+ æ–‡æª”
- åˆ†å¸ƒå¼ã€é«˜å¯ç”¨
- è±å¯Œçš„åˆ†æå™¨ï¼ˆä¸­æ–‡åˆ†è©ã€æ‹¼å¯«ç³¾æ­£ï¼‰
- æ€§èƒ½ï¼šP99 < 50ms

å®¹é‡ï¼š
- 10 å€‹æ•¸æ“šç¯€é»
- æ¯ç¯€é» 64 GB å…§å­˜
- æ”¯æŒ 5,000 è¬å•†å“
- æ¯ç§’ 50,000 æ¬¡æŸ¥è©¢
```

## çœŸå¯¦æ¡ˆä¾‹ï¼šGoogle æœå°‹å»ºè­°çš„æ¼”é€²

Google çš„è‡ªå‹•è£œå…¨åŠŸèƒ½ï¼ˆGoogle Suggestï¼‰çš„æŠ€è¡“æ¼”é€²ï¼š

### 2004 å¹´ï¼ˆåˆç‰ˆï¼‰

```
æ¶æ§‹ï¼š
- ç°¡å–®çš„å‰ç¶´åŒ¹é…
- åŸºæ–¼æœå°‹æ­·å²çš„ç†±åº¦æ’åº
- å–®ä¸€æ•¸æ“šä¸­å¿ƒ

å•é¡Œï¼š
- å»¶é²é«˜ï¼ˆ300-500msï¼‰
- ç„¡å€‹æ€§åŒ–
- ç„¡æ‹¼å¯«ç³¾æ­£
```

### 2010 å¹´ï¼ˆå€‹æ€§åŒ–ï¼‰

```
æ¶æ§‹ï¼š
- åˆ†å±¤ç´¢å¼•ï¼š
  - L1ï¼šç”¨æˆ¶å€‹äººæœå°‹æ­·å²ï¼ˆcookieï¼‰
  - L2ï¼šåœ°ç†ä½ç½®ç›¸é—œï¼ˆIPï¼‰
  - L3ï¼šå…¨å±€ç†±é–€æŸ¥è©¢
- å¤šæ•¸æ“šä¸­å¿ƒåˆ†å¸ƒ
- å¯¦æ™‚æ›´æ–°ï¼ˆæ¯ 10 åˆ†é˜ï¼‰

å„ªåŒ–ï¼š
- å»¶é²é™è‡³ 50-100ms
- å€‹æ€§åŒ–å»ºè­°
```

### 2020 å¹´ï¼ˆAI å¢å¼·ï¼‰

```
æ¶æ§‹ï¼š
- æ·±åº¦å­¸ç¿’æ¨¡å‹ï¼š
  - BERTï¼šç†è§£èªç¾©
  - Transformerï¼šé æ¸¬ä¸‹ä¸€å€‹è©
- å¯¦æ™‚æµè™•ç†ï¼š
  - ç†±é–€è©±é¡Œå³æ™‚æ›´æ–°ï¼ˆå¦‚çªç™¼æ–°èï¼‰
- åˆ†å¸ƒå¼ Servingï¼š
  - é‚Šç·£ç¯€é»ç·©å­˜
  - å…¨çƒ 100+ æ•¸æ“šä¸­å¿ƒ

æ€§èƒ½ï¼š
- å»¶é²ï¼šP99 < 20ms
- QPSï¼šå…¨çƒ æ•¸ç™¾è¬/ç§’
- æº–ç¢ºç‡ï¼š90%+ ç”¨æˆ¶é¸æ“‡ç¬¬ä¸€å€‹å»ºè­°

æŠ€è¡“æ£§ï¼š
- Bigtableï¼šå­˜å„²ç´¢å¼•
- Spannerï¼šå…¨å±€ä¸€è‡´æ€§
- TensorFlowï¼šæ¨¡å‹æ¨ç†
```

åƒè€ƒè³‡æ–™ï¼š
- [How Google Autocomplete Works](https://blog.google/products/search/how-google-autocomplete-predictions-work/)
- Google å°ˆåˆ©ï¼šUS 8,972,394 B1ï¼ˆSearch Query Refinementsï¼‰

## ç¸½çµèˆ‡å°æ¯”

### æ ¸å¿ƒè¨­è¨ˆåŸå‰‡

```
1. Trie æ¨¹ï¼ˆå‰ç¶´æ¨¹ï¼‰
   å•é¡Œï¼šç·šæ€§æƒæ O(N) å¤ªæ…¢
   æ–¹æ¡ˆï¼šæŒ‰å‰ç¶´çµ„ç¹”ï¼ŒO(M) æŸ¥è©¢ï¼ˆM = å‰ç¶´é•·åº¦ï¼‰
   æ•ˆæœï¼š2,840ms â†’ 3msï¼ˆæå‡ 946 å€ï¼‰

2. Top K å„ªåŒ–ï¼ˆæœ€å°å †ï¼‰
   å•é¡Œï¼šè¿”å›æ‰€æœ‰çµæœå†æ’åºï¼ˆæµªè²»ï¼‰
   æ–¹æ¡ˆï¼šç¶­è­·å¤§å°ç‚º K çš„æœ€å°å †
   æ•ˆæœï¼š1,300ms â†’ 283msï¼ˆæå‡ 4.6 å€ï¼‰

3. å£“ç¸® Trieï¼ˆRadix Treeï¼‰
   å•é¡Œï¼šå…§å­˜å ç”¨å¤§ï¼ˆ7.7 GBï¼‰
   æ–¹æ¡ˆï¼šåˆä½µå–®å­ç¯€é»è·¯å¾‘
   æ•ˆæœï¼šç¯€çœ 54% å…§å­˜

4. æ¨¡ç³ŠåŒ¹é…ï¼ˆç·¨è¼¯è·é›¢ï¼‰
   å•é¡Œï¼šæ‹¼å¯«éŒ¯èª¤ç„¡æ³•åŒ¹é…
   æ–¹æ¡ˆï¼šLevenshtein Distanceï¼ˆé™åˆ¶åœ¨ Top è©ï¼‰
   æ•ˆæœï¼š50ms æ¨¡ç³ŠåŒ¹é…ï¼ˆå¯æ¥å—ï¼‰
```

### æ–¹æ¡ˆå°æ¯”

| æ–¹æ¡ˆ | æ™‚é–“è¤‡é›œåº¦ | ç©ºé–“è¤‡é›œåº¦ | å„ªå‹¢ | åŠ£å‹¢ |
|------|-----------|-----------|------|------|
| **SQL LIKE** | O(N Ã— M) | O(1) | ç°¡å–® | æ¥µæ…¢ï¼ˆ2.8sï¼‰ |
| **ç·šæ€§æƒæ** | O(N) | O(N) | å¯¦ç¾ç°¡å–® | æ…¢ï¼ˆ680msï¼‰ |
| **Trie æ¨¹** | O(M + K) | O(ç¸½å­—ç¬¦æ•¸) | å¿«ï¼ˆ3msï¼‰ | å…§å­˜å¤§ |
| **Radix Tree** | O(M + K) | O(ç¯€é»æ•¸) | å¿« + çœå…§å­˜ | å¯¦ç¾è¤‡é›œ |
| **Elasticsearch** | O(log N) | åˆ†å¸ƒå¼ | è¶…å¿« + å¯æ“´å±• | é‹ç¶­æˆæœ¬é«˜ |

### é©ç”¨å ´æ™¯

**é©åˆä½¿ç”¨ Trie çš„å ´æ™¯ï¼š**
- æœå°‹è‡ªå‹•è£œå…¨ï¼ˆå¦‚ Googleï¼‰
- IDE ä»£ç¢¼è£œå…¨ï¼ˆå¦‚ VSCodeï¼‰
- å‘½ä»¤è¡Œè£œå…¨ï¼ˆå¦‚ zshï¼‰
- IP è·¯ç”±è¡¨ï¼ˆæœ€é•·å‰ç¶´åŒ¹é…ï¼‰
- æ‹¼å¯«æª¢æŸ¥

**ä¸é©åˆçš„å ´æ™¯ï¼š**
- å®Œå…¨æ¨¡ç³ŠåŒ¹é…ï¼ˆç”¨å€’æ’ç´¢å¼•ï¼‰
- èªç¾©æœå°‹ï¼ˆç”¨å‘é‡æ•¸æ“šåº«ï¼‰
- å…¨æ–‡æª¢ç´¢ï¼ˆç”¨ Elasticsearchï¼‰

### é—œéµæŒ‡æ¨™

```
æœ€çµ‚æ€§èƒ½ï¼ˆTrie + Top K + Radix Treeï¼‰ï¼š
- æ”¯æŒå•†å“æ•¸ï¼š1,000 è¬
- æŸ¥è©¢å»¶é²ï¼šP99 < 5ms
- å…§å­˜å ç”¨ï¼š3.5 GB
- QPSï¼š5,000ï¼ˆå–®æ©Ÿï¼‰
- é‡å•Ÿæ™‚é–“ï¼š15 ç§’ï¼ˆå¿«ç…§åŠ è¼‰ï¼‰

èˆ‡ç«¶å“å°æ¯”ï¼š
- æ·˜å¯¶ï¼šP99 < 50ms âœ… æˆ‘å€‘æ›´å¿«
- äº¬æ±ï¼šP99 < 100ms âœ… æˆ‘å€‘æ›´å¿«
- Googleï¼šP99 < 20ms âŒ éœ€è¦ AI å¢å¼·
```

### å»¶ä¼¸é–±è®€

**æ•¸æ“šçµæ§‹ï¼š**
- Trieï¼ˆå‰ç¶´æ¨¹ï¼‰
- Radix Treeï¼ˆå£“ç¸® Trieï¼‰
- Ternary Search Treeï¼ˆTSTï¼‰
- BK-Treeï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰

**ç®—æ³•ï¼š**
- Top K å•é¡Œï¼ˆæœ€å°å †ï¼‰
- Levenshtein Distanceï¼ˆç·¨è¼¯è·é›¢ï¼‰
- N-gramï¼ˆåˆ†è©ï¼‰
- TF-IDFï¼ˆç›¸é—œæ€§æ’åºï¼‰

**å·¥æ¥­å¯¦è¸ï¼š**
- Elasticsearchï¼šå…¨æ–‡æª¢ç´¢å¼•æ“
- Redis RediSearchï¼šè¼•é‡ç´šæœå°‹
- Apache Solrï¼šä¼æ¥­ç´šæœå°‹
- Typesenseï¼šé–‹æºæ›¿ä»£å“

---

å¾ã€Œé€±ä¸€æ—©ä¸Šçš„ç”¢å“è©•å¯©æœƒè­°ã€åˆ°ã€ŒP99 å»¶é² < 5ms çš„é«˜æ€§èƒ½ç³»çµ±ã€ï¼ŒSearch Autocomplete ç¶“æ­·äº† 5 æ¬¡é‡å¤§æ¼”é€²ï¼š

1. **SQL LIKE ç½é›£** â†’ Trie æ¨¹
2. **ç·šæ€§æƒææ…¢** â†’ å‰ç¶´åŒ¹é…
3. **çµæœå¤ªå¤š** â†’ Top K å„ªåŒ–
4. **å…§å­˜çˆ†ç‚¸** â†’ Radix Tree å£“ç¸®
5. **æ‹¼å¯«éŒ¯èª¤** â†’ ç·¨è¼¯è·é›¢æ¨¡ç³ŠåŒ¹é…

**è¨˜ä½ï¼š** å¥½çš„æœå°‹é«”é©—ä¸åƒ…æ˜¯ã€Œæ‰¾å¾—åˆ°ã€ï¼Œæ›´æ˜¯ã€Œæ‰¾å¾—å¿«ã€å’Œã€Œæ‰¾å¾—æº–ã€ã€‚Trie æ¨¹è®“æˆ‘å€‘åœ¨æµ·é‡æ•¸æ“šä¸­ç¬é–“å®šä½ï¼ŒTop K è®“æˆ‘å€‘åªè¿”å›æœ€ç›¸é—œçš„çµæœï¼Œæ¨¡ç³ŠåŒ¹é…è®“æˆ‘å€‘å®¹éŒ¯æ‹¼å¯«éŒ¯èª¤ã€‚é€™äº›å„ªåŒ–ç–ŠåŠ èµ·ä¾†ï¼Œæ‰èƒ½æä¾›å¦‚çµ²èˆ¬é †æ»‘çš„ç”¨æˆ¶é«”é©—ã€‚
