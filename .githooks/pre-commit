#!/bin/bash
# Pre-commit Hook for System Design Project
# Âú® git commit ÂâçËá™ÂãïÊ™¢Êü•‰ª£Á¢ºË≥™Èáè

set -e

echo "üîç Running pre-commit checks..."

# È°èËâ≤ÂÆöÁæ©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ê™¢Êü•ÊòØÂê¶ÂÆâË£ù‰∫ÜÂøÖË¶ÅÁöÑÂ∑•ÂÖ∑
check_tools() {
    local missing_tools=()

    if ! command -v golangci-lint &> /dev/null; then
        missing_tools+=("golangci-lint")
    fi

    if ! command -v gofmt &> /dev/null; then
        missing_tools+=("gofmt")
    fi

    if [ ${#missing_tools[@]} -ne 0 ]; then
        echo -e "${RED}‚ùå Missing tools: ${missing_tools[*]}${NC}"
        echo "Run: make install-tools"
        exit 1
    fi
}

# 1. Ê™¢Êü•Ê†ºÂºè
echo "‚Üí Checking code format..."
unformatted=$(gofmt -l .)
if [ -n "$unformatted" ]; then
    echo -e "${RED}‚ùå Code formatting issues found:${NC}"
    echo "$unformatted"
    echo ""
    echo "Run: make fmt"
    exit 1
fi
echo -e "${GREEN}‚úÖ Format check passed${NC}"

# 2. ÈÅãË°å golangci-lintÔºàÂÉÖÊ™¢Êü•Êö´Â≠òÁöÑÊñá‰ª∂Ôºâ
echo "‚Üí Running golangci-lint..."
# Áç≤ÂèñÊö´Â≠òÁöÑ Go Êñá‰ª∂
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$staged_files" ]; then
    # Âè™Ê™¢Êü•Êö´Â≠òÁöÑÊñá‰ª∂ÔºàÊèêÈ´òÈÄüÂ∫¶Ôºâ
    #
    # Á≥ªÁµ±Ë®≠Ë®àËÄÉÈáèÔºö
    #   - ‰ΩøÁî® tr '\n' '\0' | xargs -0 ËôïÁêÜÊñá‰ª∂Âêç‰∏≠ÁöÑÁ©∫Ê†º
    #   - \0ÔºànullÔºâ‰ΩúÁÇ∫ÂàÜÈöîÁ¨¶ÔºåËÄå‰∏çÊòØÊèõË°åÁ¨¶ÊàñÁ©∫Ê†º
    #   - ÈÅøÂÖçÊñá‰ª∂ÂêçÂåÖÂê´Á©∫Ê†ºÊôÇÁöÑËß£ÊûêÈåØË™§
    echo "$staged_files" | tr '\n' '\0' | xargs -0 golangci-lint run --config=.golangci.yml || {
        echo -e "${RED}‚ùå Linting failed${NC}"
        echo "Run: make lint-fix (to auto-fix)"
        exit 1
    }
fi
echo -e "${GREEN}‚úÖ Linting passed${NC}"

# 3. ÈÅãË°åÂø´ÈÄüÊ∏¨Ë©¶
echo "‚Üí Running quick tests..."
go test -short ./... > /dev/null 2>&1 || {
    echo -e "${RED}‚ùå Tests failed${NC}"
    echo "Run: make test"
    exit 1
}
echo -e "${GREEN}‚úÖ Tests passed${NC}"

# 4. Ê™¢Êü• go.mod/go.sum
echo "‚Üí Verifying go modules..."
go mod tidy
git diff --exit-code go.mod go.sum > /dev/null 2>&1 || {
    echo -e "${YELLOW}‚ö†Ô∏è  go.mod or go.sum changed${NC}"
    echo "Please review and stage the changes"
    exit 1
}
echo -e "${GREEN}‚úÖ Go modules verified${NC}"

echo ""
echo -e "${GREEN}‚ú® All pre-commit checks passed!${NC}"
exit 0
