.PHONY: help start stop server consumer test bench clean

help: ## é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

start: ## å•Ÿå‹• NATS Server
	docker-compose up -d
	@echo "â³ ç­‰å¾… NATS Server å•Ÿå‹•..."
	@sleep 3
	@echo "âœ… NATS Server å·²å•Ÿå‹•"
	@echo "ğŸ“Š ç›£æ§é¢æ¿: http://localhost:8222"

stop: ## åœæ­¢ NATS Server
	docker-compose down

server: ## å•Ÿå‹• HTTP API Server
	go run cmd/server/main.go

consumer: ## å•Ÿå‹• Consumerï¼ˆQueue Group æ¨¡å¼ï¼‰
	go run cmd/consumer/main.go --group order-processor --id 1

consumer-multi: ## å•Ÿå‹•å¤šå€‹ Consumerï¼ˆè² è¼‰å‡è¡¡æ¼”ç¤ºï¼‰
	@echo "å•Ÿå‹• 3 å€‹ Consumer..."
	@go run cmd/consumer/main.go --group order-processor --id 1 & \
	 go run cmd/consumer/main.go --group order-processor --id 2 & \
	 go run cmd/consumer/main.go --group order-processor --id 3
	@echo "âœ… 3 å€‹ Consumer å·²å•Ÿå‹•ï¼ˆQueue Group: order-processorï¼‰"

demo: ## æ¼”ç¤ºæ¨¡å¼ï¼ˆè‡ªå‹•ç™¼é€æ¶ˆæ¯ï¼‰
	DEMO_MODE=true go run cmd/server/main.go

test: ## é‹è¡Œæ¸¬è©¦
	go test ./internal/... -v

bench: ## æ€§èƒ½æ¸¬è©¦
	@echo "ä½¿ç”¨ NATS Bench é€²è¡Œæ€§èƒ½æ¸¬è©¦..."
	@echo "å®‰è£ NATS CLI: go install github.com/nats-io/natscli/nats@latest"
	nats bench orders --msgs 10000 --size 1024 --pub 5 --sub 5

clean: ## æ¸…ç†è³‡æº
	docker-compose down -v
	rm -rf nats-data/

logs: ## æŸ¥çœ‹ NATS æ—¥èªŒ
	docker-compose logs -f nats

status: ## æŸ¥çœ‹ Stream ç‹€æ…‹
	@echo "éœ€è¦å®‰è£ NATS CLI: go install github.com/nats-io/natscli/nats@latest"
	nats stream ls
	nats stream info ORDERS

init: ## åˆå§‹åŒ–å°ˆæ¡ˆä¾è³´
	go mod download
	@echo "âœ… ä¾è³´å·²ä¸‹è¼‰"
