name: CI

# 觸發條件：
#   - 推送到任何分支
#   - Pull Request 到 main 分支
#   - 手動觸發（workflow_dispatch）
on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

# 權限設置
permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  # ============================================
  # Job 1: 代碼質量檢查
  # ============================================
  lint:
    name: Lint & Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 完整歷史（golangci-lint 需要）

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'  # 使用最新穩定版
          cache: true

      - name: Verify Go modules
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "go.mod or go.sum is not up to date" && exit 1)

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=10m --config=.golangci.yml
          # 僅檢查新增/修改的代碼（提高效率）
          only-new-issues: false

      - name: Check formatting (gofmt)
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "以下文件格式不正確："
            echo "$unformatted"
            exit 1
          fi

      - name: Security scan (gosec)
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt=json -out=gosec-report.json ./... || true
          gosec ./...

  # ============================================
  # Job 2: 單元測試 & 覆蓋率
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.23', '1.24']  # 測試多個 Go 版本

    services:
      # PostgreSQL 服務（用於集成測試）
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Redis 服務
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/testdb?sslmode=disable
          REDIS_URL: redis://localhost:6379
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.go-version == '1.24'  # 只上傳一次
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: false  # 不因為上傳失敗而中斷 CI

  # ============================================
  # Job 3: SQL 驗證（sqlc）
  # ============================================
  sqlc-verify:
    name: SQL Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install sqlc
        run: go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest

      - name: Verify sqlc generated code (Counter Service)
        working-directory: 01-counter-service
        run: |
          if [ -f sqlc.yaml ]; then
            sqlc generate
            git diff --exit-code || (echo "sqlc 生成的代碼不是最新的，請運行 'sqlc generate'" && exit 1)
          fi

  # ============================================
  # Job 4: 構建驗證
  # ============================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - 01-counter-service
          - 02-room-management
          - 03-url-shortener

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Build ${{ matrix.project }}
        working-directory: ${{ matrix.project }}
        run: |
          go build -v -o /tmp/app ./cmd/server/main.go

      - name: Verify binary
        run: |
          test -f /tmp/app
          file /tmp/app

  # ============================================
  # Job 5: 依賴安全檢查
  # ============================================
  dependency-check:
    name: Dependency Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  # ============================================
  # Job 6: 代碼複雜度分析
  # ============================================
  complexity:
    name: Code Complexity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install gocyclo
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Check cyclomatic complexity
        run: |
          # 檢查圈複雜度 > 15 的函數
          gocyclo -over 15 . || echo "Warning: 某些函數複雜度較高"

  # ============================================
  # Summary Job（所有檢查通過後才成功）
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test, sqlc-verify, build, dependency-check]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.sqlc-verify.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.dependency-check.result }}" != "success" ]]; then
            echo "❌ CI 檢查失敗"
            exit 1
          fi
          echo "✅ 所有 CI 檢查通過"
